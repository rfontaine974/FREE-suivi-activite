<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Suivi des HNO</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --free-primary: #E80029; --free-light-bg:#F5F5F5; --free-dark:#333333; }
        body{font-family:Roboto,Arial,sans-serif;margin:0;background:var(--free-light-bg);color:var(--free-dark)}
        header{background:var(--free-primary);color:#fff;padding:14px 0;box-shadow:0 4px 10px rgba(0,0,0,0.2);position:sticky;top:0;z-index:1000}
        .header-content{width:90%;max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
        .free-logo-small{height:28px;filter:grayscale(1) brightness(100);vertical-align:middle}
        .nav-toggle{display:inline-block;background:transparent;border:1px solid rgba(255,255,255,0.15);color:#fff;padding:8px 10px;border-radius:6px;cursor:pointer;font-size:18px}
        .nav-toggle i{transition:transform 220ms ease,color 220ms ease;font-size:18px;display:inline-block;line-height:1}
        .nav-toggle.open i{transform:rotate(90deg) scale(1.05);color:#fff}
        .title{font-size:1.5em;font-weight:900;margin:0;padding-left:20px;border-left:1px solid rgba(255,255,255,0.5)}
        .header-link{color:#fff;text-decoration:none;font-weight:700;border:1px solid rgba(255,255,255,0.25);padding:8px 12px;border-radius:6px;display:none}
        .header-link.show{display:inline-block}
        .container{width:90%;max-width:1100px;margin:20px auto}
        .card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
        .form-group{margin-bottom:12px}
        label{display:block;margin-bottom:6px;font-weight:600}
        input,textarea,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
        .row{display:flex;gap:12px;align-items:flex-start}
        .col{flex:1}
        .btn{background:var(--free-primary);color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
        .btn.secondary{background:#eee;color:#333}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{padding:8px;border-bottom:1px solid #f0f0f0}
        th{background:#fafafa;text-align:left}
        .actions button{background:none;border:none;color:#c82333;cursor:pointer}
        tbody tr{cursor:pointer;transition:background-color 0.15s}
        tbody tr:hover{background-color:#f9f9f9}
        .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.6)}
        .modal-content{background-color:#fefefe;margin:5% auto;padding:30px;border:none;width:90%;max-width:800px;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
        .close-button{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
        .close-button:hover{color:var(--free-primary)}
        .todo-container{background:#fafafa;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-top:8px}
        .todo-input-row{display:flex;gap:8px;margin-bottom:10px}
        .todo-input-row input{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px}
        .todo-add-btn{background:var(--free-primary);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600}
        .todo-add-btn:hover{opacity:0.9}
        .todo-list{max-height:200px;overflow-y:auto;margin-top:8px}
        .todo-item{display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:6px;margin-bottom:6px;border:1px solid #e8e8e8;transition:all 0.2s}
        .todo-item:hover{box-shadow:0 2px 4px rgba(0,0,0,0.08)}
        .todo-status{padding:4px 10px;border-radius:12px;font-size:0.75em;font-weight:700;text-transform:uppercase;white-space:nowrap;cursor:pointer;transition:all 0.2s}
        .todo-status.a-faire{background:#ffc107;color:#000}
        .todo-status.en-cours{background:#17a2b8;color:#fff}
        .todo-status.termine{background:#28a745;color:#fff}
        .todo-text{flex:1;font-size:0.9em;color:#333}
        .todo-delete{background:none;border:none;color:#dc3545;cursor:pointer;font-size:1.1em;padding:0 6px}
        .todo-delete:hover{color:#c82333}
        /* Statut global du ticket */
        .status-badge{padding:4px 10px;border-radius:12px;font-size:0.8em;font-weight:700;display:inline-block}
        .status-a-prendre{background:#ffc107;color:#000}
        .status-en-cours{background:#17a2b8;color:#fff}
        .status-stagnant{background:#E80029;color:#fff}
        .status-termine{background:#28a745;color:#fff}
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div style="display:flex;align-items:center;gap:12px;">
                <button class="nav-toggle" aria-label="Afficher le menu" aria-expanded="false" onclick="toggleNavHNO()"><i class="fas fa-bars" aria-hidden="true"></i></button>
                <img class="free-logo-small" src="https://raw.githubusercontent.com/rfontaine974/FREE-suivi-activite/main/Free_logo.svg.png" alt="Logo Free">
                <h1 class="title">Suivi des HNO</h1>
            </div>
            <a class="header-link" href="index.html">Suivi OT</a>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <h2>Ajouter un Ticket HNO</h2>
            <form id="hnoFormMain" onsubmit="handleHNOFormMain(event)">
                <div class="form-group">
                    <label for="hnoDesignationMain">D√©signation de la T√¢che <span style="color:var(--free-primary);">*</span></label>
                    <input id="hnoDesignationMain" type="text" placeholder="Ex: Maintenance antenne" required>
                </div>
                <div class="row">
                    <div class="col form-group">
                        <label for="hnoSiteMain">Code Site <span style="color:var(--free-primary);">*</span></label>
                        <input id="hnoSiteMain" type="text" placeholder="Ex: S1-IDF" required>
                    </div>
                    <div class="col form-group">
                        <label for="hnoDateLimiteMain">Date Limite Souhait√©e</label>
                        <input id="hnoDateLimiteMain" type="date">
                    </div>
                </div>
                <div class="row">
                    <div class="col form-group">
                        <label for="hnoStatusTicketMain">Statut du Ticket</label>
                        <select id="hnoStatusTicketMain">
                            <option value="A prendre en charge">A prendre en charge</option>
                            <option value="En cours">En cours</option>
                            <option value="Stagnant">Stagnant</option>
                            <option value="Termin√©">Termin√©</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="hnoDescMain">Description de l'Intervention</label>
                    <textarea id="hnoDescMain" rows="3" placeholder="D√©tails de l'intervention..."></textarea>
                </div>
                <div class="form-group">
                    <label>Todo Liste</label>
                    <div class="todo-container">
                        <div class="todo-input-row">
                            <input id="hnoTodoInputMain" type="text" placeholder="Nouvelle t√¢che...">
                            <button type="button" class="todo-add-btn" onclick="addTodoTaskMain()">+ Ajouter</button>
                        </div>
                        <div id="hnoTodoListMain" class="todo-list"></div>
                    </div>
                </div>
                <div style="display:flex;gap:8px">
                    <button class="btn" type="submit">Ajouter</button>
                    <button type="button" class="btn secondary" onclick="resetHNOFormMain()">R√©initialiser</button>
                    <button type="button" class="btn secondary" onclick="exportHNOCsvMain()">Exporter CSV</button>
                </div>
            </form>
        </div>

        <div class="card" style="margin-top:16px">
            <h3>Liste des Tickets HNO</h3>
            <div style="overflow-x:auto">
                <table id="hnoTableMain"><thead><tr><th>D√©signation</th><th>Code Site</th><th>Date Limite</th><th>Statut</th><th>Description</th><th>Todo</th><th>Actions</th></tr></thead><tbody id="hnoTableBodyMain"><tr><td colspan="7" style="text-align:center;color:#666;padding:12px">Aucun enregistrement.</td></tr></tbody></table>
            </div>
        </div>
    </div>

    <div id="editModalHNO" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModalHNO()">&times;</span>
            <h2 style="text-align:center;border-bottom:2px solid var(--free-primary);padding-bottom:15px;font-weight:700;margin-top:10px;">Modifier le Ticket HNO</h2>
            <form id="editFormHNO" onsubmit="handleEditSubmitHNO(event)">
                <input type="hidden" id="editHNOId">
                <div class="form-group">
                    <label for="editHNODesignation">D√©signation de la T√¢che <span style="color:var(--free-primary);">*</span></label>
                    <input id="editHNODesignation" type="text" required>
                </div>
                <div class="row">
                    <div class="col form-group">
                        <label for="editHNOSite">Code Site <span style="color:var(--free-primary);">*</span></label>
                        <input id="editHNOSite" type="text" required>
                    </div>
                    <div class="col form-group">
                        <label for="editHNODateLimite">Date Limite Souhait√©e</label>
                        <input id="editHNODateLimite" type="date">
                    </div>
                </div>
                <div class="row">
                    <div class="col form-group">
                        <label for="editHNOStatusTicket">Statut du Ticket</label>
                        <select id="editHNOStatusTicket">
                            <option value="A prendre en charge">A prendre en charge</option>
                            <option value="En cours">En cours</option>
                            <option value="Stagnant">Stagnant</option>
                            <option value="Termin√©">Termin√©</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editHNODesc">Description de l'Intervention</label>
                    <textarea id="editHNODesc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Todo Liste</label>
                    <div class="todo-container">
                        <div class="todo-input-row">
                            <input id="editTodoInputHNO" type="text" placeholder="Nouvelle t√¢che...">
                            <button type="button" class="todo-add-btn" onclick="addTodoTaskEdit()">+ Ajouter</button>
                        </div>
                        <div id="editTodoListHNO" class="todo-list"></div>
                    </div>
                </div>
                <button type="submit" class="btn" style="width:100%;margin-top:10px;">Enregistrer les Modifications</button>
            </form>
        </div>
    </div>

    <script>
        let currentTodoListMain = [];
        let currentTodoListEdit = [];
        
        function toggleNavHNO(){
            const toggle = document.querySelector('.nav-toggle');
            if(!toggle) return;
            const icon = toggle.querySelector('i');
            const isOpen = toggle.classList.toggle('open');
            toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            const headerLink = document.querySelector('.header-link');
            if(headerLink){ headerLink.classList.toggle('show', isOpen); }
            if(icon){
                if(isOpen){ icon.classList.remove('fa-bars'); icon.classList.add('fa-times'); }
                else { icon.classList.remove('fa-times'); icon.classList.add('fa-bars'); }
            }
        }
        const HNO_KEY = 'suivi_hno_list_v1';
        function getList(){try{return JSON.parse(localStorage.getItem(HNO_KEY)||'[]')}catch(e){return[]}}
        function saveList(l){localStorage.setItem(HNO_KEY,JSON.stringify(l))}
        function handleHNOFormMain(e){e.preventDefault();const designation=document.getElementById('hnoDesignationMain').value.trim();const site=document.getElementById('hnoSiteMain').value.trim();const dateLimite=document.getElementById('hnoDateLimiteMain').value;const desc=document.getElementById('hnoDescMain').value.trim();const status=document.getElementById('hnoStatusTicketMain').value; if(!designation||!site){alert('D√©signation et Code Site requis');return}const item={id:Date.now(),designation,site,dateLimite:dateLimite||'',desc,status:status||'A prendre en charge',todoList:[...currentTodoListMain]};const l=getList();l.unshift(item);saveList(l);render();resetHNOFormMain()}
        function resetHNOFormMain(){document.getElementById('hnoFormMain').reset();document.getElementById('hnoDateLimiteMain').value='';document.getElementById('hnoDesignationMain').value='';document.getElementById('hnoSiteMain').value='';document.getElementById('hnoDescMain').value='';document.getElementById('hnoStatusTicketMain').value='A prendre en charge';currentTodoListMain=[];renderTodoListMain()}
        function addTodoTaskMain(){const input=document.getElementById('hnoTodoInputMain');const text=input.value.trim();if(!text)return;currentTodoListMain.push({text,status:'a-faire'});input.value='';renderTodoListMain()}
        function removeTodoTaskMain(index){currentTodoListMain.splice(index,1);renderTodoListMain()}
        function cycleTodoStatusMain(index){const statuses=['a-faire','en-cours','termine'];const current=currentTodoListMain[index].status;const idx=statuses.indexOf(current);currentTodoListMain[index].status=statuses[(idx+1)%3];renderTodoListMain()}
        function renderTodoListMain(){const container=document.getElementById('hnoTodoListMain');container.innerHTML='';if(!currentTodoListMain.length){container.innerHTML='<div style="text-align:center;color:#999;font-style:italic;padding:8px;">Aucune t√¢che ajout√©e</div>';return}currentTodoListMain.forEach((task,idx)=>{const div=document.createElement('div');div.className='todo-item';const statusLabels={'a-faire':'√Ä faire','en-cours':'En cours','termine':'Termin√©'};div.innerHTML=`<span class="todo-status ${task.status}" onclick="cycleTodoStatusMain(${idx})">${statusLabels[task.status]}</span><span class="todo-text">${escapeHtml(task.text)}</span><button class="todo-delete" onclick="removeTodoTaskMain(${idx})">üóëÔ∏è</button>`;container.appendChild(div)})}
        function render(){const b=document.getElementById('hnoTableBodyMain');const l=getList();b.innerHTML='';if(!l.length){b.innerHTML='<tr><td colspan="7" style="text-align:center;color:#666;padding:12px">Aucun enregistrement.</td></tr>';return}l.forEach(it=>{const tr=document.createElement('tr');const dlFormatted=it.dateLimite?new Date(it.dateLimite).toLocaleDateString('fr-FR'):'N/A';const todoList=it.todoList||[];const todoCount=todoList.length;const todoDone=todoList.filter(t=>t.status==='termine').length;const todoPreview=todoCount>0?`${todoDone}/${todoCount} termin√©es`:'‚Äî';const statusClass = (it.status||'A prendre en charge').toLowerCase();const statusMap = {'a prendre en charge':'status-a-prendre','en cours':'status-en-cours','stagnant':'status-stagnant','termin√©':'status-termine'};const cls = statusMap[statusClass] || 'status-a-prendre';tr.innerHTML=`<td>${escapeHtml(it.designation||'')}</td><td>${escapeHtml(it.site)}</td><td>${dlFormatted}</td><td><span class="${cls} status-badge">${escapeHtml(it.status||'A prendre en charge')}</span></td><td>${escapeHtml(it.desc)}</td><td style="font-style:italic;color:#666;">${todoPreview}</td><td class="actions"><button title="Supprimer" onclick="event.stopPropagation();deleteItem(${it.id})">üóëÔ∏è</button></td>`;tr.onclick=()=>openEditModalHNO(it);b.appendChild(tr)})}
        function deleteItem(id){if(!confirm('Supprimer ?'))return;saveList(getList().filter(x=>x.id!==id));render()}
        function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[ch])}
        function exportHNOCsvMain(){const l=getList();if(!l.length){alert('Aucun HNO √† exporter');return}const headers=['Designation','Code_Site','Date_Limite','Statut','Description','Todo_Tasks','Todo_Completed'];const rows=l.map(i=>{const todoList=i.todoList||[];const tasks=todoList.map(t=>`${t.text} [${t.status}]`).join('; ');const completed=todoList.filter(t=>t.status==='termine').length;return[i.designation||'',i.site,i.dateLimite||'',i.status||'A prendre en charge',i.desc||'',tasks,`${completed}/${todoList.length}`]});const csv=[headers,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""') }"`).join(',')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`hno_export_${new Date().toISOString().slice(0,10)}.csv`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}
        function openEditModalHNO(item){document.getElementById('editHNOId').value=item.id;document.getElementById('editHNODesignation').value=item.designation||'';document.getElementById('editHNOSite').value=item.site||'';document.getElementById('editHNODateLimite').value=item.dateLimite||'';document.getElementById('editHNODesc').value=item.desc||'';document.getElementById('editHNOStatusTicket').value=item.status||'A prendre en charge';currentTodoListEdit=item.todoList?JSON.parse(JSON.stringify(item.todoList)):[];renderTodoListEdit();document.getElementById('editModalHNO').style.display='block'}
        function closeEditModalHNO(){document.getElementById('editModalHNO').style.display='none'}
        function addTodoTaskEdit(){const input=document.getElementById('editTodoInputHNO');const text=input.value.trim();if(!text)return;currentTodoListEdit.push({text,status:'a-faire'});input.value='';renderTodoListEdit()}
        function removeTodoTaskEdit(index){currentTodoListEdit.splice(index,1);renderTodoListEdit()}
        function cycleTodoStatusEdit(index){const statuses=['a-faire','en-cours','termine'];const current=currentTodoListEdit[index].status;const idx=statuses.indexOf(current);currentTodoListEdit[index].status=statuses[(idx+1)%3];renderTodoListEdit()}
        function renderTodoListEdit(){const container=document.getElementById('editTodoListHNO');container.innerHTML='';if(!currentTodoListEdit.length){container.innerHTML='<div style="text-align:center;color:#999;font-style:italic;padding:8px;">Aucune t√¢che ajout√©e</div>';return}currentTodoListEdit.forEach((task,idx)=>{const div=document.createElement('div');div.className='todo-item';const statusLabels={'a-faire':'√Ä faire','en-cours':'En cours','termine':'Termin√©'};div.innerHTML=`<span class="todo-status ${task.status}" onclick="cycleTodoStatusEdit(${idx})">${statusLabels[task.status]}</span><span class="todo-text">${escapeHtml(task.text)}</span><button class="todo-delete" onclick="removeTodoTaskEdit(${idx})">üóëÔ∏è</button>`;container.appendChild(div)})}
        function handleEditSubmitHNO(e){e.preventDefault();const id=parseInt(document.getElementById('editHNOId').value);const designation=document.getElementById('editHNODesignation').value.trim();const site=document.getElementById('editHNOSite').value.trim();const dateLimite=document.getElementById('editHNODateLimite').value;const desc=document.getElementById('editHNODesc').value.trim();const status=document.getElementById('editHNOStatusTicket').value; if(!designation||!site){alert('D√©signation et Code Site requis');return}const l=getList();const index=l.findIndex(it=>it.id===id);if(index!==-1){l[index]={...l[index],designation,site,dateLimite:dateLimite||'',desc,status:status||'A prendre en charge',todoList:[...currentTodoListEdit]};saveList(l);render();closeEditModalHNO()}else{alert('Ticket introuvable')}}
        window.onclick=function(event){const modal=document.getElementById('editModalHNO');if(event.target==modal){closeEditModalHNO()}}
        document.addEventListener('DOMContentLoaded',render);
    </script>
</body>
</html>
