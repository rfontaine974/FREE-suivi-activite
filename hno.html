<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Suivi des HNO</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --free-primary: #E80029; --free-light-bg:#F5F5F5; --free-dark:#333333; }
        body{font-family:Roboto,Arial,sans-serif;margin:0;background:var(--free-light-bg);color:var(--free-dark)}
        header{background:var(--free-primary);color:#fff;padding:14px 0;box-shadow:0 4px 10px rgba(0,0,0,0.2);position:sticky;top:0;z-index:1000}
        .header-content{width:90%;max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
        .free-logo-small{height:28px;filter:grayscale(1) brightness(100);vertical-align:middle}
        .nav-toggle{display:inline-block;background:transparent;border:1px solid rgba(255,255,255,0.15);color:#fff;padding:8px 10px;border-radius:6px;cursor:pointer;font-size:18px}
        .nav-toggle i{transition:transform 220ms ease,color 220ms ease;font-size:18px;display:inline-block;line-height:1}
        .nav-toggle.open i{transform:rotate(90deg) scale(1.05);color:#fff}
        .title{font-size:1.5em;font-weight:900;margin:0;padding-left:20px;border-left:1px solid rgba(255,255,255,0.5)}
        .header-link{color:#fff;text-decoration:none;font-weight:700;border:1px solid rgba(255,255,255,0.25);padding:8px 12px;border-radius:6px;display:none}
        .header-link.show{display:inline-block}
        .new-ticket-button{background-color:#FFECEF;color:var(--free-primary);padding:10px 20px;border-radius:6px;text-decoration:none;font-weight:700;font-size:1em;transition:opacity 0.3s;border:none;box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:pointer}
        .new-ticket-button:hover{opacity:0.9}
        .container{width:90%;max-width:1100px;margin:20px auto}
        .card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
        .form-group{margin-bottom:20px;display:flex;flex-direction:column}
        label{display:block;margin-bottom:8px;font-weight:600;color:var(--free-dark);font-size:0.95em;letter-spacing:0.3px}
        input,textarea,select{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-family:Roboto,Arial,sans-serif;font-size:0.95em;transition:all 0.3s ease;background-color:#fff}
        input:focus,textarea:focus,select:focus{outline:none;border-color:var(--free-primary);box-shadow:0 0 0 3px rgba(232,0,41,0.1);background-color:#fafbfc}
        .btn{background:linear-gradient(135deg,var(--free-primary) 0%,#c70020 100%);color:#fff;padding:14px 28px;border-radius:8px;border:none;cursor:pointer;font-weight:700;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(232,0,41,0.2);width:100%;margin-top:10px;font-size:1em}
        .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(232,0,41,0.3)}
        .btn:active{transform:translateY(0)}
        .btn.secondary{background:#eee;color:#333;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .btn.secondary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        table{width:100%;border-collapse:collapse;margin-top:25px;border:1px solid #eee;box-shadow:0 0 10px rgba(0,0,0,0.05)}
        th,td{padding:12px 18px;text-align:left;border-bottom:1px solid #eee}
        th{background-color:var(--free-primary);color:white;font-weight:700;text-transform:uppercase;font-size:0.8em}
        tbody tr:nth-child(even){background-color:white}
        tbody tr:nth-child(odd){background-color:var(--free-light-bg)}
        .actions button{background:none;border:none;color:#c82333;cursor:pointer}
        .delete-button{background:none;border:none;color:#dc3545;cursor:pointer;font-size:1.2em;transition:color 0.2s}
        .delete-button:hover{color:#c82333}
        tbody tr{cursor:pointer;transition:background-color 0.15s ease-in-out}
        tbody tr:hover{background-color:#e9e9e9 !important}
        .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4);backdrop-filter:blur(2px)}
        .modal-content{background:linear-gradient(135deg,#ffffff 0%,#f8f9fa 100%);margin:3% auto;padding:0;border:none;width:90%;max-width:850px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.15);animation:animatetop 0.4s}
        @keyframes animatetop{from{top:-300px;opacity:0}to{top:3%;opacity:1}}
        .modal-content h2{background:linear-gradient(135deg,var(--free-primary) 0%,#c70020 100%);color:#fff;margin:0;padding:25px 30px;font-size:1.5em;border-bottom:none;box-shadow:0 2px 8px rgba(232,0,41,0.2)}
        .modal-content form{padding:30px}
        .close-button{position:absolute;right:20px;top:20px;color:#fff;font-size:28px;font-weight:bold;cursor:pointer;z-index:10;transition:transform 0.2s}
        .close-button:hover{transform:scale(1.2)}
        .history-container{margin-top:0;padding:25px 30px;border-top:2px solid #e8e8e8;background-color:rgba(232,0,41,0.02)}
        .history-container h3{color:var(--free-primary);font-size:1.1em;font-weight:700;margin:0 0 20px 0}
        .history-item{padding:12px;background:#f5f5f5;border-radius:6px;border-left:3px solid var(--free-primary);margin-bottom:12px;font-size:0.9em}
        .history-meta{font-size:0.8em;color:#666;margin-bottom:6px;font-weight:600}
        .history-change{font-size:0.9em;color:#333;line-height:1.5}
        .comment-container{margin-top:0 !important;padding:25px 30px !important;border-top:2px solid #e8e8e8;background-color:rgba(232,0,41,0.02)}
        .comment-container h3{color:var(--free-primary);font-size:1.1em;font-weight:700;margin:0 0 15px 0}
        .comment-container textarea{width:100% !important;padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.95em;min-height:80px;font-family:Roboto,Arial,sans-serif;transition:all 0.3s ease}
        .comment-container textarea:focus{outline:none;border-color:var(--free-primary);box-shadow:0 0 0 3px rgba(232,0,41,0.1)}
        .comment-container > div{display:flex;gap:10px;margin-top:12px}
        .comment-container input{flex:1;padding:12px 15px !important;border:2px solid #e0e0e0 !important;border-radius:8px !important;font-size:0.95em !important;transition:all 0.3s ease !important}
        .comment-container input:focus{outline:none !important;border-color:var(--free-primary) !important;box-shadow:0 0 0 3px rgba(232,0,41,0.1) !important}
        .comment-container .btn{flex:0 0 auto;white-space:nowrap;width:auto;padding:12px 24px}
        .todo-container{background:#fafafa;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-top:8px}
        .todo-input-row{display:flex;gap:8px;margin-bottom:10px}
        .todo-input-row input{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px}
        .todo-add-btn{background:var(--free-primary);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600}
        .todo-add-btn:hover{opacity:0.9}
        .todo-list{max-height:200px;overflow-y:auto;margin-top:8px}
        .todo-item{display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:6px;margin-bottom:6px;border:1px solid #e8e8e8;transition:all 0.2s}
        .todo-item:hover{box-shadow:0 2px 4px rgba(0,0,0,0.08)}
        .todo-status{padding:4px 10px;border-radius:12px;font-size:0.75em;font-weight:700;text-transform:uppercase;white-space:nowrap;cursor:pointer;transition:all 0.2s}
        .todo-status.a-faire{background:#ffc107;color:#000}
        .todo-status.en-cours{background:#17a2b8;color:#fff}
        .todo-status.termine{background:#28a745;color:#fff}
        .todo-text{flex:1;font-size:0.9em;color:#333}
        .todo-delete{background:none;border:none;color:#dc3545;cursor:pointer;font-size:1.1em;padding:0 6px}
        .todo-delete:hover{color:#c82333}
        /* Statut global du ticket */
        .status-badge{padding:4px 10px;border-radius:12px;font-size:0.8em;font-weight:700;display:inline-block}
        .status-a-prendre{background:#ffc107;color:#000}
        .status-en-cours{background:#17a2b8;color:#fff}
        .status-stagnant{background:#E80029;color:#fff}
        .status-termine{background:#28a745;color:#fff}
        .retard{color:white;background-color:var(--free-primary);padding:3px 6px;border-radius:3px;font-weight:700;text-align:center}
        @keyframes blink{0%,100%{background-color:#ffe6e6}50%{background-color:#ffcccc}}
        .row-retard{animation:blink 2s ease-in-out infinite}
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div style="display:flex;align-items:center;gap:12px;">
                <button class="nav-toggle" aria-label="Afficher le menu" aria-expanded="false" onclick="toggleNavHNO()"><i class="fas fa-bars" aria-hidden="true"></i></button>
                <img class="free-logo-small" src="https://raw.githubusercontent.com/rfontaine974/FREE-suivi-activite/main/Free_logo.svg.png" alt="Logo Free">
                <h1 class="title">Suivi des HNO</h1>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
                <a class="header-link" href="index.html">üìã OT</a>
                <a class="header-link" href="analyse.html">üìä Analyse</a>
                <button onclick="openCreateModalHNO()" class="new-ticket-button">+ Cr√©er un Nouveau Ticket HNO</button>
            </div>
        </div>
    </header>

    <div class="container">
        <h2>Tableau de Bord</h2>
        <div class="section-separator" style="border-bottom:1px solid #ddd;margin-bottom:30px;"></div>
        <div class="kpi-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:25px;margin:0 20px 40px 20px;">
            <div class="kpi-card" style="background:white;border-left:5px solid var(--free-primary);border-radius:4px;padding:20px;text-align:left;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                <h3 style="margin:0 0 5px 0;font-size:0.9em;color:#666;text-transform:uppercase;">Nouveaux HNO</h3>
                <div class="kpi-value" id="kpiNouveaux" style="font-size:2.8em;font-weight:900;color:#333;">0</div>
            </div>
            <div class="kpi-card" style="background:white;border-left:5px solid var(--free-primary);border-radius:4px;padding:20px;text-align:left;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                <h3 style="margin:0 0 5px 0;font-size:0.9em;color:#666;text-transform:uppercase;">HNO en cours</h3>
                <div class="kpi-value" id="kpiEnCours" style="font-size:2.8em;font-weight:900;color:#333;">0</div>
            </div>
            <div class="kpi-card" style="background:white;border-left:5px solid var(--free-primary);border-radius:4px;padding:20px;text-align:left;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                <h3 style="margin:0 0 5px 0;font-size:0.9em;color:#666;text-transform:uppercase;">HNO Termin√©s</h3>
                <div class="kpi-value" id="kpiTermines" style="font-size:2.8em;font-weight:900;color:#28a745;">0</div>
            </div>
        </div>
        <h2 style="margin-top:20px;">Liste des Tickets HNO</h2>
        <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
            <button type="button" class="btn secondary" onclick="exportHNOCsvMain()">Exporter CSV</button>
        </div>
        <div style="overflow-x:auto">
            <table id="hnoTableMain"><thead><tr><th>D√©signation</th><th>Code Site</th><th>Date Limite</th><th>Statut</th><th>Description</th><th>Todo</th><th>Actions</th></tr></thead><tbody id="hnoTableBodyMain"><tr><td colspan="7" style="text-align:center;color:#666;padding:12px">Aucun enregistrement.</td></tr></tbody></table>
        </div>
    </div>

    <div id="createModalHNO" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCreateModalHNO()">&times;</span>
            <h2 style="text-align:center;border-bottom:2px solid var(--free-primary);padding-bottom:15px;font-weight:700;margin-top:10px;">Cr√©er un Nouveau Ticket HNO</h2>
            <form id="hnoFormMain" onsubmit="handleHNOFormMain(event)">
                <div class="form-group">
                    <label for="hnoDesignationMain">D√©signation de la T√¢che <span style="color:var(--free-primary);">*</span></label>
                    <input id="hnoDesignationMain" type="text" placeholder="Ex: Maintenance antenne" required>
                </div>
                <div class="row">
                    <div class="col form-group">
                        <label for="hnoSiteMain">Code Site <span style="color:var(--free-primary);">*</span></label>
                        <input id="hnoSiteMain" type="text" placeholder="Ex: S1-IDF" required>
                    </div>
                    <div class="col form-group">
                        <label for="hnoDateLimiteMain">Date Limite Souhait√©e</label>
                        <input id="hnoDateLimiteMain" type="date">
                    </div>
                </div>
                <div class="row">
                    <div class="col form-group">
                        <label for="hnoStatusTicketMain">Statut du Ticket</label>
                        <select id="hnoStatusTicketMain">
                            <option value="A prendre en charge">A prendre en charge</option>
                            <option value="En cours">En cours</option>
                            <option value="Stagnant">Stagnant</option>
                            <option value="Termin√©">Termin√©</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="hnoDescMain">Description de l'Intervention</label>
                    <textarea id="hnoDescMain" rows="3" placeholder="D√©tails de l'intervention..."></textarea>
                </div>
                <div class="form-group">
                    <label>Todo Liste</label>
                    <div class="todo-container">
                        <div class="todo-input-row">
                            <input id="hnoTodoInputMain" type="text" placeholder="Nouvelle t√¢che...">
                            <button type="button" class="todo-add-btn" onclick="addTodoTaskMain()">+ Ajouter</button>
                        </div>
                        <div id="hnoTodoListMain" class="todo-list"></div>
                    </div>
                </div>
                <button type="submit" class="btn" style="width:100%;margin-top:10px;">Cr√©er le Ticket HNO</button>
            </form>
        </div>
    </div>

    <div id="createModalHNO" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCreateModalHNO()">&times;</span>
            <h2>‚ûï Cr√©er un Nouveau Ticket HNO</h2>
            <form id="hnoFormMain" onsubmit="handleHNOFormMain(event)">
                <div style="margin-bottom:25px;">
                    <h3 style="color:var(--free-primary);font-size:1em;margin:0 0 15px 0;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">üìã Informations G√©n√©rales</h3>
                    <div class="form-group">
                        <label for="hnoDesignationMain">üìù D√©signation de la T√¢che <span style="color:var(--free-primary);">*</span></label>
                        <input id="hnoDesignationMain" type="text" placeholder="Ex: Maintenance antenne" required>
                    </div>
                    <div class="form-group">
                        <label for="hnoDescMain">üìÑ Description de l'Intervention</label>
                        <textarea id="hnoDescMain" placeholder="D√©tails de l'intervention..."></textarea>
                    </div>
                </div>
                <div style="margin-bottom:25px;">
                    <h3 style="color:var(--free-primary);font-size:1em;margin:0 0 15px 0;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">üè¢ Localisation & D√©lais</h3>
                    <div class="row">
                        <div class="col form-group">
                            <label for="hnoSiteMain">üìç Code Site <span style="color:var(--free-primary);">*</span></label>
                            <input id="hnoSiteMain" type="text" placeholder="Ex: S1-IDF" required>
                        </div>
                        <div class="col form-group">
                            <label for="hnoDateLimiteMain">üìÖ Date Limite Souhait√©e</label>
                            <input id="hnoDateLimiteMain" type="date">
                        </div>
                    </div>
                </div>
                <div style="margin-bottom:25px;">
                    <h3 style="color:var(--free-primary);font-size:1em;margin:0 0 15px 0;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">üìä Statut & T√¢ches</h3>
                    <div class="form-group">
                        <label for="hnoStatusTicketMain">‚úÖ Statut du Ticket</label>
                        <select id="hnoStatusTicketMain">
                            <option value="A prendre en charge">üî¥ A prendre en charge</option>
                            <option value="En cours">üü° En cours</option>
                            <option value="Stagnant">üü† Stagnant</option>
                            <option value="Termin√©">üü¢ Termin√©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‚úèÔ∏è Todo Liste</label>
                        <div class="todo-container">
                            <div class="todo-input-row">
                                <input id="hnoTodoInputMain" type="text" placeholder="Nouvelle t√¢che...">
                                <button type="button" class="todo-add-btn" onclick="addTodoTaskMain()">+ Ajouter</button>
                            </div>
                            <div id="hnoTodoListMain" class="todo-list"></div>
                        </div>
                    </div>
                </div>
                <button class="btn" type="submit">‚úÖ Cr√©er le Ticket HNO</button>
            </form>
        </div>
    </div>

    <div id="editModalHNO" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModalHNO()">&times;</span>
            <h2>‚úèÔ∏è Modifier le Ticket HNO</h2>
            <form id="editFormHNO" onsubmit="handleEditSubmitHNO(event)">
                <input type="hidden" id="editHNOId">
                <div style="margin-bottom:25px;">
                    <h3 style="color:var(--free-primary);font-size:1em;margin:0 0 15px 0;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">üìã Informations G√©n√©rales</h3>
                    <div class="form-group">
                        <label for="editHNODesignation">üìù D√©signation de la T√¢che <span style="color:var(--free-primary);">*</span></label>
                        <input id="editHNODesignation" type="text" required>
                    </div>
                    <div class="form-group">
                        <label>üìÑ Description de l'Intervention</label>
                        <div id="editHNODesc" style="padding:12px;background:#f5f5f5;border-radius:6px;border:1px solid #eee;min-height:50px;white-space:pre-wrap;word-wrap:break-word;line-height:1.6;font-size:0.95em;color:#666;cursor:not-allowed;"></div>
                    </div>
                </div>
                <div style="margin-bottom:25px;">
                    <h3 style="color:var(--free-primary);font-size:1em;margin:0 0 15px 0;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">üè¢ Localisation & D√©lais</h3>
                    <div class="row">
                        <div class="col form-group">
                            <label for="editHNOSite">üìç Code Site <span style="color:var(--free-primary);">*</span></label>
                            <input id="editHNOSite" type="text" required>
                        </div>
                        <div class="col form-group">
                            <label for="editHNODateLimite">üìÖ Date Limite Souhait√©e</label>
                            <input id="editHNODateLimite" type="date">
                        </div>
                    </div>
                </div>
                <div style="margin-bottom:25px;">
                    <h3 style="color:var(--free-primary);font-size:1em;margin:0 0 15px 0;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">üìä Statut & T√¢ches</h3>
                    <div class="form-group">
                        <label for="editHNOStatusTicket">‚úÖ Statut du Ticket</label>
                        <select id="editHNOStatusTicket">
                            <option value="A prendre en charge">üî¥ A prendre en charge</option>
                            <option value="En cours">üü° En cours</option>
                            <option value="Stagnant">üü† Stagnant</option>
                            <option value="Termin√©">üü¢ Termin√©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‚úèÔ∏è Todo Liste</label>
                        <div class="todo-container">
                            <div class="todo-input-row">
                                <input id="editTodoInputHNO" type="text" placeholder="Nouvelle t√¢che...">
                                <button type="button" class="todo-add-btn" onclick="addTodoTaskEdit()">+ Ajouter</button>
                            </div>
                            <div id="editTodoListHNO" class="todo-list"></div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn">üíæ Enregistrer les Modifications</button>
            </form>
            <div style="display:flex;gap:10px;margin-top:15px;padding:15px;background:#f9f9f9;border-radius:8px;border-top:2px solid #e8e8e8;">
                <button type="button" class="btn" onclick="if(confirm('√ätes-vous s√ªr de vouloir archiver ce ticket ?')) { archiveItemHNO(parseInt(document.getElementById('editHNOId').value)); closeEditModalHNO(); }" style="flex:1;background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%);">üì¶ Archiver ce ticket</button>
                <button type="button" class="btn" onclick="if(confirm('√ätes-vous s√ªr de vouloir supprimer ce ticket ?')) { deleteItem(parseInt(document.getElementById('editHNOId').value)); closeEditModalHNO(); }" style="flex:1;background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);">üóëÔ∏è Supprimer</button>
            </div>
            <div class="history-container">
                <h3>üìã Historique Complet</h3>
                <div id="historyListHNO"></div>
            </div>
            <div class="comment-container">
                <h3>üí¨ Ajouter un commentaire</h3>
                <textarea id="newCommentText" placeholder="Votre commentaire..."></textarea>
                <div>
                    <input type="text" id="newCommentAuthor" placeholder="Auteur (optionnel)">
                    <button type="button" class="btn" onclick="addCommentHNO()">üí¨ Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTodoListMain = [];
        let currentTodoListEdit = [];
        
        function toggleNavHNO(){
            const toggle = document.querySelector('.nav-toggle');
            if(!toggle) return;
            const icon = toggle.querySelector('i');
            const isOpen = toggle.classList.toggle('open');
            toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            const headerLink = document.querySelector('.header-link');
            if(headerLink){ headerLink.classList.toggle('show', isOpen); }
            if(icon){
                if(isOpen){ icon.classList.remove('fa-bars'); icon.classList.add('fa-times'); }
                else { icon.classList.remove('fa-times'); icon.classList.add('fa-bars'); }
            }
        }
        const HNO_KEY = 'suivi_hno_list_v1';
        function getList(){try{return JSON.parse(localStorage.getItem(HNO_KEY)||'[]')}catch(e){return[]}}
        function saveList(l){localStorage.setItem(HNO_KEY,JSON.stringify(l))}
        function openCreateModalHNO(){document.getElementById('createModalHNO').style.display='block'}
        function closeCreateModalHNO(){document.getElementById('createModalHNO').style.display='none'}
        function handleHNOFormMain(e){e.preventDefault();const designation=document.getElementById('hnoDesignationMain').value.trim();const site=document.getElementById('hnoSiteMain').value.trim().toUpperCase();const dateLimite=document.getElementById('hnoDateLimiteMain').value;const desc=document.getElementById('hnoDescMain').value.trim();const status=document.getElementById('hnoStatusTicketMain').value; if(!designation||!site){alert('D√©signation et Code Site requis');return}const item={id:Date.now(),designation,site,dateLimite:dateLimite||'',desc,status:status||'A prendre en charge',todoList:[...currentTodoListMain]};const l=getList();l.unshift(item);saveList(l);render();resetHNOFormMain();closeCreateModalHNO()}
        function resetHNOFormMain(){document.getElementById('hnoFormMain').reset();document.getElementById('hnoDateLimiteMain').value='';document.getElementById('hnoDesignationMain').value='';document.getElementById('hnoSiteMain').value='';document.getElementById('hnoDescMain').value='';document.getElementById('hnoStatusTicketMain').value='A prendre en charge';currentTodoListMain=[];renderTodoListMain()}
        function updateKPIs(){const l=getList();const nouveaux=l.filter(t=>(t.status||'A prendre en charge')==='A prendre en charge').length;const enCours=l.filter(t=>(t.status||'')==='En cours').length;const termines=l.filter(t=>(t.status||'')==='Termin√©').length;document.getElementById('kpiNouveaux').textContent=nouveaux;document.getElementById('kpiEnCours').textContent=enCours;document.getElementById('kpiTermines').textContent=termines}
        function addTodoTaskMain(){const input=document.getElementById('hnoTodoInputMain');const text=input.value.trim();if(!text)return;currentTodoListMain.push({text,status:'a-faire'});input.value='';renderTodoListMain()}
        function removeTodoTaskMain(index){currentTodoListMain.splice(index,1);renderTodoListMain()}
        function cycleTodoStatusMain(index){const statuses=['a-faire','en-cours','termine'];const current=currentTodoListMain[index].status;const idx=statuses.indexOf(current);currentTodoListMain[index].status=statuses[(idx+1)%3];renderTodoListMain()}
        function renderTodoListMain(){const container=document.getElementById('hnoTodoListMain');container.innerHTML='';if(!currentTodoListMain.length){container.innerHTML='<div style="text-align:center;color:#999;font-style:italic;padding:8px;">Aucune t√¢che ajout√©e</div>';return}currentTodoListMain.forEach((task,idx)=>{const div=document.createElement('div');div.className='todo-item';const statusLabels={'a-faire':'√Ä faire','en-cours':'En cours','termine':'Termin√©'};div.innerHTML=`<span class="todo-status ${task.status}" onclick="cycleTodoStatusMain(${idx})">${statusLabels[task.status]}</span><span class="todo-text">${escapeHtml(task.text)}</span><button class="todo-delete" onclick="removeTodoTaskMain(${idx})">üóëÔ∏è</button>`;container.appendChild(div)})}
        function render(){const b=document.getElementById('hnoTableBodyMain');let l=getList().filter(x=>x.archived!==true&&x.archived!=='true');l.sort((a,b)=>{const dateA=a.dateLimite?new Date(a.dateLimite):new Date('9999-12-31');const dateB=b.dateLimite?new Date(b.dateLimite):new Date('9999-12-31');return dateA.getTime()-dateB.getTime()});b.innerHTML='';if(!l.length){b.innerHTML='<tr><td colspan="7" style="text-align:center;color:#666;padding:12px">Aucun enregistrement.</td></tr>';updateKPIs();return}l.forEach(it=>{const tr=document.createElement('tr');const todoList=it.todoList||[];const todoCount=todoList.length;const todoDone=todoList.filter(t=>t.status==='termine').length;const todoPreview=todoCount>0?`${todoDone}/${todoCount} termin√©es`:'‚Äî';const statusClass = (it.status||'A prendre en charge').toLowerCase();const statusMap = {'a prendre en charge':'status-a-prendre','en cours':'status-en-cours','stagnant':'status-stagnant','termin√©':'status-termine'};const cls = statusMap[statusClass] || 'status-a-prendre';const dateLimiteVal=it.dateLimite?new Date(it.dateLimite):null;const aujourdHui=new Date();aujourdHui.setHours(0,0,0,0);let dlFormatted='N/A';const oneDay=1000*60*60*24;const daysOverdue=dateLimiteVal?Math.floor((aujourdHui.getTime()-dateLimiteVal.getTime())/oneDay):0;const statutRaw=(it.status||'').toUpperCase().trim();const statutResolus=['R√âSOLU','RESOLU','TERMIN√â','TERMINER','RESOLU.','ANNUL√â'];if(dateLimiteVal){dlFormatted=dateLimiteVal.toLocaleDateString('fr-FR')}if(daysOverdue>0&&!statutResolus.includes(statutRaw)){dlFormatted=`<span class="retard">J+${daysOverdue}</span>`;tr.classList.add('row-retard')}const descText=it.desc||'';const descPreview=descText.length>50?descText.substring(0,50)+'...':descText;tr.innerHTML=`<td>${escapeHtml(it.designation||'')}</td><td>${escapeHtml((it.site||'').toUpperCase())}</td><td>${dlFormatted}</td><td><span class="${cls} status-badge">${escapeHtml(it.status||'A prendre en charge')}</span></td><td>${escapeHtml(descPreview)}</td><td style="font-style:italic;color:#666;">${todoPreview}</td><td class="actions"><button class="delete-button" title="Supprimer" onclick="event.stopPropagation();deleteItem(${it.id})"><i class="fas fa-trash-alt"></i></button><button class="delete-button" title="Archiver" onclick="event.stopPropagation();archiveItemHNO(${it.id})" style="margin-left:8px;"><i class="fas fa-archive"></i></button></td>`;tr.onclick=()=>openEditModalHNO(it);b.appendChild(tr)});updateKPIs()}
        function deleteItem(id){if(!confirm('Supprimer ?'))return;saveList(getList().filter(x=>x.id!==id));render()}
        function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[ch])}
        function exportHNOCsvMain(){const l=getList();if(!l.length){alert('Aucun HNO √† exporter');return}const headers=['Designation','Code_Site','Date_Limite','Statut','Description','Todo_Tasks','Todo_Completed'];const rows=l.map(i=>{const todoList=i.todoList||[];const tasks=todoList.map(t=>`${t.text} [${t.status}]`).join('; ');const completed=todoList.filter(t=>t.status==='termine').length;return[i.designation||'',i.site,i.dateLimite||'',i.status||'A prendre en charge',i.desc||'',tasks,`${completed}/${todoList.length}`]});const csv=[headers,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""') }"`).join(',')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`hno_export_${new Date().toISOString().slice(0,10)}.csv`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}
        function openEditModalHNO(item){document.getElementById('editHNOId').value=item.id;document.getElementById('editHNODesignation').value=item.designation||'';document.getElementById('editHNOSite').value=item.site||'';document.getElementById('editHNODateLimite').value=item.dateLimite||'';document.getElementById('editHNODesc').textContent=item.desc||'Pas de description.';document.getElementById('editHNOStatusTicket').value=item.status||'A prendre en charge';currentTodoListEdit=item.todoList?JSON.parse(JSON.stringify(item.todoList)):[];renderTodoListEdit();document.getElementById('editModalHNO').style.display='block'}
        function closeEditModalHNO(){document.getElementById('editModalHNO').style.display='none'}
        function addTodoTaskEdit(){const input=document.getElementById('editTodoInputHNO');const text=input.value.trim();if(!text)return;currentTodoListEdit.push({text,status:'a-faire'});input.value='';renderTodoListEdit()}
        function removeTodoTaskEdit(index){currentTodoListEdit.splice(index,1);renderTodoListEdit()}
        function cycleTodoStatusEdit(index){const statuses=['a-faire','en-cours','termine'];const current=currentTodoListEdit[index].status;const idx=statuses.indexOf(current);currentTodoListEdit[index].status=statuses[(idx+1)%3];renderTodoListEdit()}
        function renderTodoListEdit(){const container=document.getElementById('editTodoListHNO');container.innerHTML='';if(!currentTodoListEdit.length){container.innerHTML='<div style="text-align:center;color:#999;font-style:italic;padding:8px;">Aucune t√¢che ajout√©e</div>';return}currentTodoListEdit.forEach((task,idx)=>{const div=document.createElement('div');div.className='todo-item';const statusLabels={'a-faire':'√Ä faire','en-cours':'En cours','termine':'Termin√©'};div.innerHTML=`<span class="todo-status ${task.status}" onclick="cycleTodoStatusEdit(${idx})">${statusLabels[task.status]}</span><span class="todo-text">${escapeHtml(task.text)}</span><button class="todo-delete" onclick="removeTodoTaskEdit(${idx})">üóëÔ∏è</button>`;container.appendChild(div)})}
        function handleEditSubmitHNO(e){e.preventDefault();const id=parseInt(document.getElementById('editHNOId').value);const designation=document.getElementById('editHNODesignation').value.trim();const site=document.getElementById('editHNOSite').value.trim().toUpperCase();const dateLimite=document.getElementById('editHNODateLimite').value;const status=document.getElementById('editHNOStatusTicket').value; if(!designation||!site){alert('D√©signation et Code Site requis');return}const l=getList();const index=l.findIndex(it=>it.id===id);if(index!==-1){l[index]={...l[index],designation,site,dateLimite:dateLimite||'',status:status||'A prendre en charge',todoList:[...currentTodoListEdit]};saveList(l);render();closeEditModalHNO()}else{alert('Ticket introuvable')}}
        window.onclick=function(event){const modal=document.getElementById('editModalHNO');if(event.target==modal){closeEditModalHNO()}}
        window.onclick=function(event){const createModal=document.getElementById('createModalHNO');const editModal=document.getElementById('editModalHNO');if(event.target==createModal){closeCreateModalHNO()}if(event.target==editModal){closeEditModalHNO()}}
        document.addEventListener('DOMContentLoaded',render);
    </script>
<script>
// --- Historique HNO ---
function nowIso() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function ensureHistory(ticket) {
    if (!ticket.history) ticket.history = [];
}

function addHistory(ticket, type, message, details) {
    ensureHistory(ticket);
    ticket.history.unshift({
        ts: nowIso(),
        type, // 'create' | 'update'
        message,
        details: details || null
    });
}

function diffTicket(oldT, newT) {
    const fields = [
        {key:'designation', label:'D√©signation'},
        {key:'site', label:'Code Site'},
        {key:'dateLimite', label:'Date Limite'},
        {key:'status', label:'Statut du ticket'},
        {key:'desc', label:'Description'},
    ];
    const changes = [];
    for (const f of fields) {
        const before = oldT[f.key] ?? '';
        const after = newT[f.key] ?? '';
        if (JSON.stringify(before) !== JSON.stringify(after)) {
            changes.push({ field: f.label, before, after });
        }
    }
    // Todos: compare text + status counts
    const beforeTodos = Array.isArray(oldT.todoList) ? oldT.todoList : [];
    const afterTodos = Array.isArray(newT.todoList) ? newT.todoList : [];
    const beforeSummary = `${beforeTodos.length} t√¢ches`;
    const afterSummary = `${afterTodos.length} t√¢ches`;
    if (beforeSummary !== afterSummary) {
        changes.push({ field: 'T√¢ches', before: beforeSummary, after: afterSummary });
    } else {
        // If same count, detect any status/text change in order
        const len = Math.max(beforeTodos.length, afterTodos.length);
        for (let i=0;i<len;i++) {
            const b = beforeTodos[i];
            const a = afterTodos[i];
            const bStr = b ? `${b.text} (${b.status})` : '-';
            const aStr = a ? `${a.text} (${a.status})` : '-';
            if (bStr !== aStr) {
                changes.push({ field: `T√¢che ${i+1}`, before: bStr, after: aStr });
            }
        }
    }
    return changes;
}

function renderHistory(ticket) {
    const container = document.getElementById('historyListHNO');
    if (!container) return;
    ensureHistory(ticket);
    if (ticket.history.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#888; font-style:italic;">Aucun historique pour ce ticket.</div>';
        return;
    }
    
    const timelineDiv = document.createElement('div');
    timelineDiv.className = 'history-timeline';
    
    ticket.history.forEach(h => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'history-entry';
        
        let icon = 'üîÑ';
        let label = 'Mise √† jour';
        if (h.type === 'create') {
            icon = '‚úÖ';
            label = 'Cr√©ation';
        } else if (h.type === 'comment') {
            icon = 'üí¨';
            label = 'Commentaire';
        }
        
        let html = `
            <div class="history-meta">
                <span>${icon} ${label}</span>
                <span>${h.ts}</span>
            </div>
        `;
        
        if (h.type === 'comment') {
            html += `<div class="history-change" style="padding:8px;background:#fff;border-radius:6px;border:1px solid #eee;white-space:pre-wrap;word-wrap:break-word;">${escapeHtml(h.message || '')}</div>`;
        } else if (h.details && Array.isArray(h.details)) {
            const details = h.details.map(c => `
                <div class="history-change">
                    <span style="font-weight:600;">${c.field}:</span> <strong>"${escapeHtml(String(c.before))}"</strong> ‚Üí <strong>"${escapeHtml(String(c.after))}"</strong>
                </div>
            `).join('');
            html += details;
        } else if (h.message) {
            html += `<div class="history-change">${escapeHtml(h.message)}</div>`;
        }
        
        entryDiv.innerHTML = html;
        timelineDiv.appendChild(entryDiv);
    });
    
    container.innerHTML = '';
    container.appendChild(timelineDiv);
}

// Hook into existing create/edit flows if present
const originalHandleHNOFormMain = window.handleHNOFormMain;
window.handleHNOFormMain = function(event) {
    if (event) event.preventDefault();
    const ticket = originalHandleHNOFormMain ? originalHandleHNOFormMain(event) : null;
    // If original returns ticket or we can access last added via storage
    try {
        const list = (typeof getList === 'function') ? getList() : JSON.parse(localStorage.getItem('suivi_hno_list_v1')||'[]');
        const last = list[list.length-1];
        if (last) {
            addHistory(last, 'create', 'Ticket cr√©√©', [
                { field: 'D√©signation', before: '', after: last.designation||'' },
                { field: 'Code Site', before: '', after: last.site||'' },
                { field: 'Date Limite', before: '', after: last.dateLimite||'' },
                { field: 'Statut du ticket', before: '', after: last.status||'' },
                { field: 'Description', before: '', after: last.desc||'' },
                { field: 'T√¢ches', before: '0 t√¢ches', after: `${Array.isArray(last.todoList)?last.todoList.length:0} t√¢ches` },
            ]);
            if (typeof saveList === 'function') saveList(list); else localStorage.setItem('suivi_hno_list_v1', JSON.stringify(list));
        }
    } catch { /* ignore */ }
    // Re-render if needed
    if (window.render) window.render();
    return ticket;
};

const originalHandleEditSubmitHNO = window.handleEditSubmitHNO;
window.handleEditSubmitHNO = function(event) {
    if (event) event.preventDefault();
    // Snapshot before
    let list = [];
    try { list = (typeof getList === 'function') ? getList() : JSON.parse(localStorage.getItem('suivi_hno_list_v1')||'[]'); } catch {}
    const id = document.getElementById('editHNOId')?.value;
    const idx = list.findIndex(t => String(t.id) === String(id));
    const before = idx >= 0 ? JSON.parse(JSON.stringify(list[idx])) : null;
    const res = originalHandleEditSubmitHNO ? originalHandleEditSubmitHNO(event) : null;
    // After update
    try { list = (typeof getList === 'function') ? getList() : JSON.parse(localStorage.getItem('suivi_hno_list_v1')||'[]'); } catch {}
    const after = idx >= 0 ? list[idx] : null;
    if (before && after) {
        const details = diffTicket(before, after);
        if (details.length) {
            addHistory(after, 'update', 'Ticket mis √† jour', details);
            if (typeof saveList === 'function') saveList(list); else localStorage.setItem('suivi_hno_list_v1', JSON.stringify(list));
        }
        // Render history in modal
        renderHistory(after);
    }
    // Re-render list if needed
    if (window.render) window.render();
    return res;
};

// When opening modal, ensure history is shown
const originalOpenEditModalHNO = window.openEditModalHNO;
window.openEditModalHNO = function(item) {
    const result = originalOpenEditModalHNO ? originalOpenEditModalHNO(item) : null;
    try {
        const list = (typeof getList === 'function') ? getList() : JSON.parse(localStorage.getItem('suivi_hno_list_v1')||'[]');
        const ticket = list.find(t => String(t.id) === String(item.id));
        if (ticket) renderHistory(ticket);
    } catch { /* ignore */ }
    return result;
};

function addCommentHNO(){
    const id = document.getElementById('editHNOId')?.value;
    const text = document.getElementById('newCommentText')?.value?.trim();
    const author = document.getElementById('newCommentAuthor')?.value?.trim();
    if (!id || !text) return;
    let list = [];
    try { list = (typeof getList === 'function') ? getList() : JSON.parse(localStorage.getItem('suivi_hno_list_v1')||'[]'); } catch {}
    const idx = list.findIndex(t => String(t.id) === String(id));
    if (idx < 0) return;
    const ticket = list[idx];
    if (!ticket.comments) ticket.comments = [];
    const entry = { ts: nowIso(), author: author || '', text };
    ticket.comments.push(entry);
    addHistory(ticket, 'comment', author ? `${author}: ${text}` : text, null);
    if (typeof saveList === 'function') saveList(list); else localStorage.setItem('suivi_hno_list_v1', JSON.stringify(list));
    // Clear inputs
    document.getElementById('newCommentText').value = '';
    document.getElementById('newCommentAuthor').value = '';
    // Re-render history
    renderHistory(ticket);
}

function archiveItemHNO(id){
    if(!confirm('√ätes-vous s√ªr de vouloir archiver ce ticket ? Il ne sera plus affich√©.')){
        return;
    }
    saveList(getList().map(x=>x.id===id?{...x,archived:true}:x));
    render();
}
</script>
</body>
</html>
