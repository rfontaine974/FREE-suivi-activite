<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi des Ordres de Travaux - FREE</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    
    <style>
        /* Variables de Couleurs FREE */
        :root {
            --free-primary: #E80029; /* Rouge vif pour l'accentuation et l'alerte */
            --free-dark: #333333;
            --free-light-bg: #F5F5F5; /* Fond principal */
            --free-text-light: #666;
            --button-bg-light: #FFECEF; /* Fond clair pour le bouton */

            /* Couleurs fonctionnelles (Priorit√©s) */
            --p1-color: var(--free-primary);
            --p2-color: #ffa500;
            --p3-color: #008000;
            --p4-color: #808080;
            --proj-spec-color: var(--free-primary); /* PROJET = ROUGE PRINCIPAL */

            /* Couleurs statuts */
            --status-pending: #ffc107;
            --status-planned: #17a2b8;
            --status-stagnant: var(--p1-color);
            --status-resolved: #28a745;

            /* Couleurs Majeurs */
            --majeur-reseau: #007bff;
            --majeur-radio: #28a745;
            --majeur-fibre: #6c757d;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--free-light-bg);
            color: var(--free-dark);
            line-height: 1.6;
        }

        header {
            background-color: var(--free-primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            max-width: 1300px;
            margin: 0 auto;
        }

        .free-logo-small {
            height: 28px; /* L√©g√®rement augment√© pour plus de visibilit√© */
            filter: grayscale(1) brightness(100); /* Astuce pour rendre un logo monochrome blanc */
            vertical-align: middle;
        }

        .new-ticket-button {
            background-color: var(--button-bg-light);
            color: var(--free-primary);
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 700;
            font-size: 1em;
            transition: opacity 0.3s;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        .new-ticket-button:hover {
            opacity: 0.9;
        }

        .container {
            width: 90%;
            max-width: 1300px;
            margin: 30px auto;
            padding: 25px 0;
        }
        /* Navigation tabs styles - hidden by default and shown when menu toggled */
        .nav-tabs { list-style: none; margin: 0; padding: 0; display: none; gap: 8px; align-items: center; }
        .nav-tabs.show { display: flex; }
        .nav-tabs li { margin: 0; }
        .tab-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
        }
        .tab-btn:hover { opacity: 0.9; }
        .tab-btn.active {
            background: white;
            color: var(--free-primary);
            border-color: rgba(0,0,0,0.06);
        }
        /* Hamburger / responsive nav */
        .nav-toggle {
            display: inline-block; /* bouton visible en permanence */
            background: transparent;
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
        }
        .nav-toggle i {
            transition: transform 220ms ease, color 220ms ease;
            font-size: 18px;
            display: inline-block;
            line-height: 1;
        }
        .nav-toggle.open i {
            transform: rotate(90deg) scale(1.05);
            color: #fff;
        }

        @media (max-width: 900px) {
            .nav-tabs { display: none; position: absolute; right: 20px; top: 60px; flex-direction: column; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
            .nav-tabs.show { display: flex; }
            .nav-toggle { display: inline-block; }
            header .header-content { align-items: center; }
            .new-ticket-button { margin-left: 8px; }
        }

        h2 {
            color: var(--free-dark);
            font-size: 2em;
            font-weight: 900;
            margin-top: 40px;
            margin-bottom: 20px;
            text-align: left;
            padding-left: 20px;
        }
        .section-separator {
            border-bottom: 1px solid #ddd;
            margin-bottom: 30px;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin: 0 20px 40px 20px;
        }

        .kpi-card {
            background: white;
            border-left: 5px solid var(--free-primary);
            border-radius: 4px;
            padding: 20px;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .kpi-card h3 {
            margin: 0 0 5px 0;
            font-size: 0.9em;
            color: var(--free-text-light);
            text-transform: uppercase;
        }

        .kpi-value {
            font-size: 2.8em;
            font-weight: 900;
            color: var(--free-dark);
        }

        .kpi-card.alert {
            border-left: 5px solid var(--p1-color);
        }
        .kpi-card.alert .kpi-value {
            color: var(--p1-color);
        }

        .ot-table-wrapper { margin: 0 20px; overflow-x: auto; position: relative; }
        .ot-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 25px; 
            border: 1px solid #eee; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        .ot-table th { 
            background-color: var(--free-primary); 
            color: white; 
            font-weight: 700; 
            text-transform: uppercase; 
            font-size: 0.8em; 
            position: relative; 
        }
        .ot-table tbody tr:nth-child(even) { background-color: white; }
        .ot-table tbody tr:nth-child(odd) { background-color: var(--free-light-bg); }
        .ot-table th, .ot-table td { padding: 12px 18px; text-align: left; border-bottom: 1px solid #eee; }
        
        .ot-table tbody tr {
            transition: background-color 0.15s ease-in-out;
        }
        .ot-table tbody tr:hover {
            background-color: #e9e9e9 !important; 
        }
        
        /* Bouton de filtre dans l'en-t√™te */
        .filter-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin-left: 5px;
            padding: 0;
            font-size: 0.9em;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .filter-btn:hover {
            opacity: 1;
        }
        
        /* Conteneur de Filtre Excel-like */
        #filterDropdown {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 200;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            min-width: 150px;
        }
        #filterDropdown .filter-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
            font-size: 0.9em;
            cursor: pointer;
        }
        #filterDropdown .filter-item:hover {
            background-color: #f0f0f0;
        }
        #filterDropdown label {
            margin-left: 8px;
            cursor: pointer;
        }
        #filterDropdown .filter-header {
            font-weight: 700;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            margin-bottom: 8px;
            font-size: 1em;
            color: var(--free-dark);
        }
        .filter-actions {
            padding-top: 10px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .filter-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .apply-btn { background-color: var(--free-primary); color: white; }
        .clear-btn { background-color: #eee; color: var(--free-dark); }


        /* Styles fonctionnels (priorit√©/statut) */
        [class*="priority-"], [class*="status-"] {
            border-radius: 3px; padding: 3px 6px; display: inline-block; font-size: 0.9em; font-weight: 500; color: white; text-align: center;
        }
        .priority-P1 { background-color: var(--p1-color); }
        .priority-P2 { background-color: var(--p2-color); }
        .priority-P3 { background-color: var(--p3-color); }
        .priority-P4 { background-color: var(--p4-color); }
        .priority-Projet { background-color: var(--proj-spec-color); }

        /* Correction des statuts : Forcer le texte noir sur les fonds clairs */
        .status-A_prendre_en_charge { 
            background-color: var(--status-pending); /* Jaune/Orange clair */
            color: black !important; /* Texte NOIR forc√© pour la lisibilit√© maximale */
        }
        .status-Planifie { 
            background-color: var(--status-planned); 
            color: white !important; 
        }
        .status-Stagnant { background-color: var(--status-stagnant); } 
        .status-Resolu { background-color: var(--status-resolved); } 
        .status-R√©solu { background-color: var(--status-resolved); } 
        .status-Annul√© { background-color: #777; } 
        .status-A_d√©finir { 
            background-color: #ccc; /* Gris tr√®s clair pour '√Ä d√©finir' */
            color: black !important; /* Texte NOIR forc√© */
        }
        
        .majeur-RESEAU { color: var(--majeur-reseau); font-weight: 500; }
        .majeur-RADIO { color: var(--majeur-radio); font-weight: 500; }
        .majeur-FIBRE { color: var(--majeur-fibre); font-weight: 500; }

        .chart-placeholder {
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            padding: 50px;
            text-align: center;
            font-style: italic;
            color: #888;
            margin: 20px 20px 40px 20px;
            border-radius: 8px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Styles de la MODALE */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 3% auto;
            padding: 0;
            border: none;
            width: 90%; 
            max-width: 850px; 
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            animation-name: animatetop;
            animation-duration: 0.4s;
            overflow: hidden;
        }

        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 3%; opacity: 1}
        }

        .modal-content h2 {
            background: linear-gradient(135deg, var(--free-primary) 0%, #c70020 100%);
            color: white;
            margin: 0;
            padding: 25px 30px;
            font-size: 1.5em;
            border-bottom: none;
            box-shadow: 0 2px 8px rgba(232, 0, 41, 0.2);
        }

        .modal-content form,
        .history-container,
        .comment-container {
            padding: 30px;
        }

        .close-button {
            position: absolute;
            right: 20px;
            top: 20px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s;
        }

        .close-button:hover,
        .close-button:focus {
            transform: scale(1.2);
            text-decoration: none;
        }

        /* Formulaire am√©lior√© */
        .form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--free-dark);
            font-size: 0.95em;
            letter-spacing: 0.3px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: 'Roboto', Arial, sans-serif;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background-color: #ffffff;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--free-primary);
            box-shadow: 0 0 0 3px rgba(232, 0, 41, 0.1);
            background-color: #fafbfc;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Roboto', Arial, sans-serif;
        }

        .form-submit-button {
            background: linear-gradient(135deg, var(--free-primary) 0%, #c70020 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(232, 0, 41, 0.2);
            margin-top: 10px;
        }

        .form-submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 0, 41, 0.3);
        }

        .form-submit-button:active {
            transform: translateY(0);
        }
        
        /* Bouton de Suppression */
        .delete-button {
            background: none;
            border: none;
            color: #dc3545; 
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.2s;
        }
        .delete-button:hover {
            color: #c82333;
        }
        /* Style pour l'affichage du Retard J+X */
        .retard {
            color: white; 
            background-color: var(--free-primary); 
            padding: 3px 6px;
            border-radius: 3px;
            font-weight: 700;
            text-align: center;
        }
        @keyframes blink{0%,100%{background-color:#ffe6e6}50%{background-color:#ffcccc}}
        .row-retard{animation:blink 2s ease-in-out infinite}
        
        /* NOUVEAUX STYLES POUR LA CHRONOLOGIE D'HISTORIQUE */

        .history-container {
            margin-top: 0;
            padding: 25px 30px;
            border-top: 2px solid #e8e8e8;
            position: relative;
            background-color: rgba(232, 0, 41, 0.02);
        }

        .history-header {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--free-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-header:before {
            content: '\f05b';
            font-family: 'Font Awesome 6 Free';
            font-weight: 600;
        }

        /* Ligne verticale de la chronologie */
        .history-timeline {
            border-left: 2px solid #e0e0e0;
            margin-left: 25px;
            padding-left: 20px;
            padding-bottom: 5px;
        }

        .history-entry {
            position: relative;
            padding: 12px 0 20px 0;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .history-entry:hover {
            padding-left: 8px;
        }

        /* Cercle de l'√©v√©nement sur la ligne du temps */
        .history-entry:before {
            content: '';
            position: absolute;
            left: -33px;
            top: 18px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--free-primary);
            border: 3px solid #ffffff;
            box-shadow: 0 0 0 2px var(--free-primary);
        }

        .history-meta {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: wrap;
        }

        .history-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .history-meta strong {
            color: var(--free-primary);
            font-weight: 600;
        }

        .history-change {
            font-size: 0.95em;
            font-weight: 500;
            color: #333;
            background-color: #f5f5f5;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--free-primary);
            line-height: 1.5;
        }

        /* Mise en √©vidence des mots cl√©s */
        .history-change strong {
            color: var(--free-primary);
        }

        /* Section des commentaires */
        .comment-container {
            margin-top: 0 !important;
            padding: 25px 30px !important;
            border-top: 2px solid #e8e8e8;
            background-color: rgba(232, 0, 41, 0.02);
        }

        .comment-container h3 {
            color: var(--free-primary);
            font-size: 1.1em;
            font-weight: 700;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comment-container h3:before {
            content: '\f075';
            font-family: 'Font Awesome 6 Free';
            font-weight: 600;
        }

        .comment-container textarea {
            width: 100% !important;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            min-height: 80px;
            font-family: 'Roboto', Arial, sans-serif;
            transition: all 0.3s ease;
        }

        .comment-container textarea:focus {
            outline: none;
            border-color: var(--free-primary);
            box-shadow: 0 0 0 3px rgba(232, 0, 41, 0.1);
        }

        .comment-container > div {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .comment-container input {
            flex: 1;
            padding: 12px 15px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 8px !important;
            font-size: 0.95em !important;
            transition: all 0.3s ease !important;
        }

        .comment-container input:focus {
            outline: none !important;
            border-color: var(--free-primary) !important;
            box-shadow: 0 0 0 3px rgba(232, 0, 41, 0.1) !important;
        }

        .comment-container .btn {
            background: linear-gradient(135deg, var(--free-primary) 0%, #c70020 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(232, 0, 41, 0.2);
        }

        .comment-container .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 0, 41, 0.3);
        }

        /* Style pour la pagination */
        #paginationControls button {
            background-color: #fff;
            color: var(--free-primary);
            border: 1px solid var(--free-primary);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        #paginationControls button:hover {
            background-color: var(--free-primary);
            color: white;
        }


        footer {
            text-align: center;
            padding: 30px;
            color: var(--free-text-light);
            font-size: 0.9em;
            margin-top: 50px;
            border-top: 1px solid #eee;
            background-color: white;
        }
    </style>
</head>
<body onload="initApp()">
    <header>
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 12px;">
                <button class="nav-toggle" aria-label="Afficher le menu" aria-expanded="false" onclick="toggleNav()" style="margin-right:8px;"><i class="fas fa-bars" aria-hidden="true"></i></button>
                <img class="free-logo-small" src="https://raw.githubusercontent.com/rfontaine974/FREE-suivi-activite/main/Free_logo.svg.png" alt="Logo Free">
                <h1 style="font-size: 1.5em; font-weight: 900; margin: 0; padding-left: 20px; border-left: 1px solid rgba(255, 255, 255, 0.5);">Suivi des Ordres de Travaux</h1>
            </div>
            <nav class="main-nav" aria-label="Main menu">
                <ul class="nav-tabs">
                    <li><button class="tab-btn active" data-target="tab-suivi" onclick="showTab('tab-suivi')">Suivi OT</button></li>
                    <li><button class="tab-btn" onclick="window.location.href='hno.html'">HNO</button></li>
                </ul>
            </nav>
            <button onclick="openModal()" class="new-ticket-button">+ Cr√©er un Nouveau Ticket</button>
        </div>
    </header>

    <div class="container">
        <div id="tab-suivi" class="tab-pane">
            <h2>Tableau de Bord</h2>
            <div class="section-separator"></div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <h3>Total OT Enregistr√©s</h3>
                    <div class="kpi-value" id="kpiTotal">...</div>
                </div>
                <div class="kpi-card">
                    <h3>OT En Attente de Cl√¥ture</h3>
                    <div class="kpi-value" id="kpiEnAttente">...</div>
                </div>
                <div class="kpi-card alert">
                    <h3>OT En Retard</h3>
                    <div class="kpi-value" id="kpiEnRetard">...</div>
                </div>
                <div class="kpi-card">
                    <h3>OT R√©solus ce Mois</h3>
                    <div class="kpi-value" id="kpiResolus">...</div>
                </div>
            </div>

            <div class="filter-container" style="margin: 0 20px 20px 20px; display: flex; gap: 20px; align-items: center;">
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Rechercher par ID, D√©signation ou Site..." style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; font-size: 1em;">
                
                <label for="filterStatus" style="font-weight: 500; color: var(--free-dark);">Filtre Statut</label>
                <select id="filterStatus" onchange="filterTable()" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; width: 250px;">
                    <option value="">Tous les Statuts</option>
                    <option value="√Ä prendre en charge">√Ä prendre en charge</option>
                    <option value="Planifi√©">Planifi√©</option>
                    <option value="Stagnant">Stagnant</option>
                    <option value="R√©solu">R√©solu</option>
                    <option value="Annul√©">Annul√©</option>
                </select>
            </div>
            
            <div style="margin: 0 20px 10px 20px; display: flex; justify-content: flex-end; align-items: center; font-size: 0.9em;">
                <label for="itemsPerPage">Afficher :</label>
                <select id="itemsPerPage" onchange="filterTable()" style="padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; margin-left: 10px;">
                    <option value="10">10 √©l√©ments</option>
                    <option value="20">20 √©l√©ments</option>
                    <option value="50">50 √©l√©ments</option>
                    <option value="100">100 √©l√©ments</option>
                    <option value="9999">Tout</option>
                </select>
                <span id="paginationInfo" style="margin-left: 20px; font-weight: 500;"></span>
            </div>
            
            <h2>Liste D√©taill√©e des Ordres de Travaux</h2>
            <div class="section-separator"></div>


            <div class="ot-table-wrapper">
                <div id="filterDropdown" style="display:none;"></div> 
                
                <table class="ot-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>D√©signation</th>
                            <th data-column-key="codeSite">Code Site <button class="filter-btn" onclick="event.stopPropagation(); toggleColumnFilter('codeSite', event)"><i class="fas fa-filter"></i></button></th>
                            <th data-column-key="priorite">Priorit√© <button class="filter-btn" onclick="event.stopPropagation(); toggleColumnFilter('priorite', event)"><i class="fas fa-filter"></i></button></th>
                            <th data-column-key="majeur">Majeur <button class="filter-btn" onclick="event.stopPropagation(); toggleColumnFilter('majeur', event)"><i class="fas fa-filter"></i></button></th>
                            <th data-column-key="Statut">Statut <button class="filter-btn" onclick="event.stopPropagation(); toggleColumnFilter('Statut', event)"><i class="fas fa-filter"></i></button></th>
                            <th>Date Pr√©vue</th> 
                            <th data-column-key="dateLimite">Date Limite <button class="filter-btn" onclick="event.stopPropagation(); sortTable('dateLimite')"><i class="fas fa-sort"></i></button></th>
                            <th data-column-key="Exec. Sal.">Assign√© √† <button class="filter-btn" onclick="event.stopPropagation(); toggleColumnFilter('Exec. Sal.', event)"><i class="fas fa-filter"></i></button></th>
                            <th>Actions</th> 
                        </tr>
                    </thead>
                    <tbody id="otTableBody">
                        <tr><td colspan="10" style="text-align:center;">Chargement des donn√©es...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="paginationControls" style="margin: 20px; display: flex; justify-content: center; gap: 10px;">
                </div>
        </div>

    </div> 
    <footer>
        Outil de Suivi des Ordres de Travaux | D√©veloppement interne | Free ¬© 2025
    </footer>
    
    <div id="otModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2>‚ûï Cr√©er un Nouveau Ticket OT</h2>
            
            <form id="ticketForm" onsubmit="handleFormSubmit(event)">
                <!-- Section 1: Informations de Base -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--free-primary); font-size: 1em; margin: 0 0 15px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üìã Informations G√©n√©rales</h3>
                    
                    <div class="form-group">
                        <label for="id">üÜî ID du Ticket <span style="color:red;">*</span></label>
                        <input type="text" id="id" name="ID" placeholder="Ex: OT-007" required>
                    </div>

                    <div class="form-group">
                        <label for="designation">üìù D√©signation de la T√¢che <span style="color:red;">*</span></label>
                        <input type="text" id="designation" name="designation" placeholder="Br√®ve description de la t√¢che" required>
                    </div>

                    <div class="form-group">
                        <label for="description">üìÑ Description D√©taill√©e du Probl√®me</label>
                        <textarea id="description" name="description" placeholder="D√©crivez le probl√®me en d√©tail..."></textarea>
                    </div>
                </div>

                <!-- Section 2: Localisation et Classification -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--free-primary); font-size: 1em; margin: 0 0 15px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üè¢ Localisation & Classification</h3>
                    
                    <div class="form-group">
                        <label for="siteCode">üìç Code Site (Localisation) <span style="color:red;">*</span></label>
                        <input type="text" id="siteCode" name="codeSite" placeholder="Ex: S1-IDF, B3-Lyon" required>
                    </div>

                    <div class="form-group">
                        <label for="majeur">üîß Majeur (Service concern√©) <span style="color:red;">*</span></label>
                        <select id="majeur" name="majeur" required>
                            <option value="">-- Choisir un service --</option>
                            <option value="RESEAU">üåê R√©seau</option>
                            <option value="RADIO">üì° Radio</option>
                            <option value="FIBRE">üîå Fibre</option>
                        </select>
                    </div>
                </div>

                <!-- Section 3: Priorit√© et D√©lais -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--free-primary); font-size: 1em; margin: 0 0 15px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">‚è∞ Priorit√© & D√©lais</h3>
                    
                    <div class="form-group">
                        <label for="priorite">üéØ Priorit√© demand√©e <span style="color:red;">*</span></label>
                        <select id="priorite" name="priorite" required>
                            <option value="">-- Choisir une priorit√© --</option>
                            <option value="P1">üî¥ P1 (Urgent)</option>
                            <option value="P2">üü† P2 (√âlev√©e)</option>
                            <option value="P3">üü° P3 (Normale)</option>
                            <option value="P4">üü¢ P4 (Basse)</option>
                            <option value="Projet">üìä Projet sp√©ciaux</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="dateLimite">üìÖ Date Limite souhait√©e</label>
                        <input type="date" id="dateLimite" name="dateLimite">
                    </div>
                </div>

                <button type="submit" class="form-submit-button">‚úÖ Soumettre le Ticket</button>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h2>‚úèÔ∏è √âditer le Ticket <span id="editTicketID" style="color:white;"></span></h2>
            
            <form id="editForm" onsubmit="handleEditSubmit(event)">
                <input type="hidden" id="editRowIndex" name="rowIndex">

                <!-- Section 1: Informations de Base (Lecture seule) -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--free-primary); font-size: 1em; margin: 0 0 15px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üìã Informations du Ticket</h3>
                    
                    <div class="form-group">
                        <label for="editDescription">üìÑ Description D√©taill√©e du Probl√®me</label>
                        <textarea id="editDescription" readonly style="background-color: #f5f5f5; color: #666; cursor: not-allowed;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ Date de Cr√©ation </label>
                        <input type="text" id="displayTimestamp" readonly style="background-color: #f5f5f5; color: #666; cursor: not-allowed;">
                    </div>
                </div>

                <!-- Section 2: Classification et Service -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--free-primary); font-size: 1em; margin: 0 0 15px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üîß Classification & Service</h3>
                    
                    <div class="form-group">
                        <label for="editMajeur">üîß Majeur (Service concern√©) <span style="color:red;">*</span></label>
                        <select id="editMajeur" name="majeur" required>
                            <option value="">-- Choisir un service --</option>
                            <option value="RESEAU">üåê R√©seau</option>
                            <option value="RADIO">üì° Radio</option>
                            <option value="FIBRE">üîå Fibre</option>
                        </select>
                    </div>
                </div>

                <!-- Section 3: Statut et Assignation -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--free-primary); font-size: 1em; margin: 0 0 15px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üìä Statut & Assignation</h3>
                    
                    <div class="form-group">
                        <label for="editStatut">‚úÖ Statut Actuel <span style="color:red;">*</span></label>
                        <select id="editStatut" name="Statut" required>
                            <option value="√Ä prendre en charge">üî¥ √Ä prendre en charge</option>
                            <option value="Planifi√©">üü° Planifi√©</option>
                            <option value="Stagnant">üü† Stagnant</option>
                            <option value="R√©solu">üü¢ R√©solu</option>
                            <option value="Annul√©">‚ö´ Annul√©</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAssignee">üë§ Assign√© √† :</label>
                        <select id="editAssignee" name="Exec. Sal.">
                            <option value="">(√Ä assigner)</option>
                            <option value="DEVLIN Christophe">DEVLIN Christophe</option>
                            <option value="KHERBOUCHE Zoubir">KHERBOUCHE Zoubir</option>
                            <option value="PEREIRA David">PEREIRA David</option>
                            <option value="GONNORD Bertrand">GONNORD Bertrand</option>
                            <option value="AUGE Ludovic">AUGE Ludovic</option>
                            <option value="AMAROT Jean-Fran√ßois">AMAROT Jean-Fran√ßois</option>
                            <option value="UZUN Serhat">UZUN Serhat</option>
                            <option value="GIESBERS Laurent">GIESBERS Laurent</option>
                            <option value="BEN AMOR Maroiane">BEN AMOR Maroiane</option>
                            <option value="CLOVIS Philippe">CLOVIS Philippe</option>
                        </select>
                    </div>
                </div>

                <!-- Section 4: D√©lais -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--free-primary); font-size: 1em; margin: 0 0 15px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">‚è∞ D√©lais</h3>
                    
                    <div class="form-group">
                        <label for="editDatePrevue">üìÖ Date Pr√©vue d'Intervention  <span style="color:red;">*</span></label>
                        <input type="date" id="editDatePrevue" name="dateDebPres">
                    </div>
                </div>

                <button type="submit" class="form-submit-button">üíæ Enregistrer les Modifications</button>
            </form>
            
            <div style="display:flex;gap:10px;margin-top:15px;padding:15px;background:#f9f9f9;border-radius:8px;border-top:2px solid #e8e8e8;">
                <button type="button" class="btn" onclick="archiveTicketFromModal()" style="flex:1;background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%);">üì¶ Archiver ce ticket</button>
                <button type="button" class="btn" onclick="if(confirm('√ätes-vous s√ªr de vouloir supprimer ce ticket ?')) deleteTicket(document.getElementById('editRowIndex').value);" style="flex:1;background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);">üóëÔ∏è Supprimer</button>
            </div>
            
            <div class="history-container">
                <div class="history-header">üìã Historique Complet</div>
                <div id="historyLog"></div>
            </div>
            
            <div class="comment-container">
                <h3>üí¨ Ajouter un commentaire</h3>
                <textarea id="newCommentText" placeholder="Votre commentaire..."></textarea>
                <div>
                    <input type="text" id="newCommentAuthor" placeholder="Auteur (optionnel)">
                    <button type="button" class="btn" onclick="addCommentOT()">üí¨ Ajouter</button>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // Simple tab navigation for multiple tools
        function initApp() {
            // Show default tab
            showTab('tab-suivi');
            // Load OT list for the default tab
            try { loadOTList(); } catch (e) { console.warn('loadOTList not available yet', e); }
        }

        function showTab(tabId) {
            // Hide all panes
            document.querySelectorAll('.tab-pane').forEach(p => {
                p.style.display = 'none';
            });
            // Remove active from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            // Show requested pane
            const pane = document.getElementById(tabId);
            if (pane) pane.style.display = '';

            // Mark the corresponding button active
            const btn = document.querySelector(`.tab-btn[data-target="${tabId}"]`);
            if (btn) btn.classList.add('active');

            // If the user navigates to the Suivi tab, refresh the list
            if (tabId === 'tab-suivi') {
                try { filterTable(true); } catch (e) { console.warn('filterTable not available', e); }
            }
        }

        // Toggle responsive nav (hamburger) on small screens
        function toggleNav() {
            const tabs = document.querySelector('.nav-tabs');
            const toggle = document.querySelector('.nav-toggle');
            if (!tabs || !toggle) return;
            const isShown = tabs.classList.toggle('show');

            const suiviOtButton = document.querySelector('.tab-btn[data-target="tab-suivi"]');
            if (suiviOtButton) {
                const li = suiviOtButton.parentElement;
                if (isShown && suiviOtButton.classList.contains('active')) {
                    li.style.display = 'none';
                } else {
                    li.style.display = '';
                }
            }
            
            // Toggle icon between bars and times
            const icon = toggle.querySelector('i');
            if (icon) {
                if (isShown) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                    toggle.classList.add('open');
                    toggle.setAttribute('aria-expanded', 'true');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                    toggle.classList.remove('open');
                    toggle.setAttribute('aria-expanded', 'false');
                }
            }
        }

        // Close responsive nav when clicking outside
        document.addEventListener('click', (e) => {
            const tabs = document.querySelector('.nav-tabs');
            const toggle = document.querySelector('.nav-toggle');
            if (!tabs || !toggle) return;
            if (tabs.classList.contains('show')) {
                if (!tabs.contains(e.target) && !toggle.contains(e.target)) {
                    tabs.classList.remove('show');
                    const suiviOtButton = document.querySelector('.tab-btn[data-target="tab-suivi"]');
                    if (suiviOtButton) {
                        suiviOtButton.parentElement.style.display = '';
                    }
                }
            }
        });

        // -----------------------
        // HNO Tracker (localStorage)
        // -----------------------
        const HNO_STORAGE_KEY = 'suivi_hno_list_v1';

        function getHNOList() {
            try {
                const raw = localStorage.getItem(HNO_STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                console.error('Erreur lecture HNO localStorage', e);
                return [];
            }
        }

        function saveHNOList(list) {
            localStorage.setItem(HNO_STORAGE_KEY, JSON.stringify(list));
        }

        function handleHNOForm(event) {
            event.preventDefault();
            const date = document.getElementById('hnoDate').value;
            const site = document.getElementById('hnoSite').value.trim();
            const desc = document.getElementById('hnoDesc').value.trim();
            const duration = document.getElementById('hnoDuration').value;
            const status = document.getElementById('hnoStatus').value;

            if (!date || !site) {
                alert('Date et Code Site requis.');
                return;
            }

            const list = getHNOList();
            const newItem = {
                id: Date.now(),
                date, site, desc, duration: duration || '', status
            };
            list.unshift(newItem);
            saveHNOList(list);
            renderHNOTable();
            resetHNOForm();
        }

        function resetHNOForm() {
            document.getElementById('hnoForm').reset();
            document.getElementById('hnoDate').value = '';
        }

        function renderHNOTable() {
            const tbody = document.getElementById('hnoTableBody');
            const list = getHNOList();
            tbody.innerHTML = '';
            if (!list || list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:12px; font-style:italic; color:#666;">Aucun HNO enregistr√©.</td></tr>`;
                return;
            }

            list.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:8px;">${item.date}</td>
                    <td style="padding:8px;">${escapeHtml(item.site)}</td>
                    <td style="padding:8px;">${escapeHtml(item.desc)}</td>
                    <td style="padding:8px;">${item.duration || ''}</td>
                    <td style="padding:8px;">${item.status}</td>
                    <td style="padding:8px; text-align:center;">
                        <button class="delete-button" title="Supprimer" onclick="deleteHNO(${item.id})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteHNO(id) {
            if (!confirm('Supprimer cet enregistrement HNO ?')) return;
            const list = getHNOList().filter(x => x.id !== id);
            saveHNOList(list);
            renderHNOTable();
        }

        function exportHNOCsv() {
            const list = getHNOList();
            if (!list || list.length === 0) { alert('Aucun HNO √† exporter.'); return; }

            const headers = ['Date','Site','Description','Duree_h','Statut'];
            const rows = list.map(i => [i.date, i.site, i.desc, i.duration || '', i.status]);
            const csv = [headers, ...rows].map(r => r.map(cell => '"' + String(cell || '').replace(/"/g, '""') + '"').join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hno_export_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"]+/g, function(match) {
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'} )[match];
            });
        }

        // Render HNO table on load of tools tab
        document.addEventListener('DOMContentLoaded', function() {
            try { renderHNOTable(); } catch(e){}
        });
        // ************************************************************************************
        // CONFIGURATION
        // URL DE VOTRE D√âPLOIEMENT APPS SCRIPT
        // - Par d√©faut, la valeur de fallback ci-dessous est utilis√©e.
        // - Pour d√©ployer et garder l'URL hors du code source, cr√©ez un fichier `config.js`
        //   √† la racine contenant :
        //     window.__CONFIG__ = { WEB_APP_URL: 'https://script.google.com/macros/s/XXXXX/exec' };
        //   ou copiez `config.example.js` en `config.js` et modifiez la valeur.
        // ************************************************************************************
        const WEB_APP_URL = (window.__CONFIG__ && window.__CONFIG__.WEB_APP_URL) || "https://script.google.com/macros/s/AKfycbxoc_EOEA57sWlVlI9UiRl0hxyrnY-HBGWkwObVYluvFAUw9ZtYuhLIkU0Vu9dHs-IE/exec"; 

        var modal = document.getElementById("otModal");
        var editModal = document.getElementById("editModal");
        
        let fullOTList = [];
        let activeFilters = {};
        let currentFilterColumn = null;
        let currentPage = 1;
        // Variables de tri
        let currentSortColumn = null;
        let currentSortDirection = 'asc'; // 'asc' pour croissant, 'desc' pour d√©croissant

        // ------------------------------------------------------------------
        // GESTION DES MODALES
        // ------------------------------------------------------------------
        function openModal() { closeModalFilter(); modal.style.display = "block"; }
        function closeModal() { modal.style.display = "none"; }
        function closeEditModal() { editModal.style.display = "none"; }
        
        function closeModalFilter() {
            document.getElementById('filterDropdown').style.display = 'none';
            currentFilterColumn = null;
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
            if (event.target == editModal) {
                editModal.style.display = "none";
            }
            
            const filterDropdown = document.getElementById('filterDropdown');
            if (filterDropdown.style.display === 'block' && !filterDropdown.contains(event.target) && !event.target.closest('.filter-btn')) {
                 closeModalFilter();
            }
        }
        
        // Fonction pour formater la date pour l'Historique (AVEC HEURE)
        function formatHistoryDate(isoString) {
            const date = new Date(isoString);
            const options = { 
                day: '2-digit', month: '2-digit', year: 'numeric'
            };
            // Format 02/12/2025 11:56
            return date.toLocaleDateString('fr-FR', options) + ' ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
        }

        // Fonction pour ouvrir la modale d'√©dition et pr√©-remplir les champs
        function openEditModal(ot) {
            closeModalFilter();
            document.getElementById('editRowIndex').value = ot.rowIndex;
            document.getElementById('editTicketID').textContent = ot.ID || ot.Timestamp.substring(0, 10);
            
            // 1. Affichage de la DESCRIPTION
            document.getElementById('editDescription').value = ot.description || 'Pas de description d√©taill√©e.';
            
            // 2. Affichage du MAJEUR
            document.getElementById('editMajeur').value = ot.majeur || ot.Majeur || '';

            // 3. Affichage de la DATE DE CR√âATION (Timestamp - Lecture seule SANS HEURE)
            const rawTimestamp = ot.Timestamp || 'N/A';
            let formattedTimestamp = rawTimestamp;

            try {
                if (rawTimestamp !== 'N/A') {
                    const date = new Date(rawTimestamp);
                    const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
                    formattedTimestamp = date.toLocaleDateString('fr-FR', options); 
                }
            } catch (e) {
                formattedTimestamp = rawTimestamp;
            }
            document.getElementById('displayTimestamp').value = formattedTimestamp;


            // 4. Champs √âditables restants
            document.getElementById('editStatut').value = ot.Statut || '√Ä prendre en charge';
            document.getElementById('editAssignee').value = ot['Exec. Sal.'] || ot['Exec Sal'] || '';

            // 5. Date Pr√©vue d'Intervention (dateDebPres)
            const dateDebPresValue = ot.dateDebPres;
            if (dateDebPresValue && dateDebPresValue !== '') {
                document.getElementById('editDatePrevue').value = dateDebPresValue.slice(0, 10);
            } else {
                document.getElementById('editDatePrevue').value = '';
            }
            
            // 6. Affichage de l'historique fusionn√© avec les commentaires
            const ticketId = ot.ID || ot.Timestamp.substring(0, 10);
            renderMergedHistoryOT(ot, ticketId);

            editModal.style.display = "block";
        }


        // ------------------------------------------------------------------
        // LOGIQUE DE TRI
        // ------------------------------------------------------------------
        function sortTable(columnKey) {
            closeModalFilter(); 

            // 1. D√©terminer la direction de tri
            if (currentSortColumn === columnKey) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnKey;
                currentSortDirection = 'asc';
            }

            // 2. Fonction de comparaison sp√©cifique pour les dates
            if (columnKey === 'dateLimite') {
                const compareDates = (a, b) => {
                    // Les dates manquantes sont positionn√©es en fin de liste (valeur tr√®s √©lev√©e)
                    const dateA = a[columnKey] ? new Date(a[columnKey]) : new Date('9999-12-31');
                    const dateB = b[columnKey] ? new Date(b[columnKey]) : new Date('9999-12-31');

                    if (currentSortDirection === 'asc') {
                        return dateA.getTime() - dateB.getTime();
                    } else {
                        return dateB.getTime() - dateA.getTime();
                    }
                };
                fullOTList.sort(compareDates);
            }

            // 3. Mettre √† jour l'affichage
            filterTable(true); // Red√©marre √† la premi√®re page
        }

        // ------------------------------------------------------------------
        // LOGIQUE DE FILTRAGE PAR COLONNE (Excel-like)
        // ------------------------------------------------------------------

        function getOTValue(ot, key) {
            let value = ot[key] || '';
            
            if (key === 'Exec. Sal.') {
                value = ot['Exec. Sal.'] || ot['Exec Sal'] || '';
            }
            
            if (key === 'priorite') value = ot.priorite || ot.prio || '';
            if (key === 'majeur') value = ot.majeur || ot.Majeur || '';
            if (key === 'Statut') value = ot.Statut || ot.statut || '';
            
            return String(value || '(Non renseign√©)').trim();
        }

        function toggleColumnFilter(key, event) {
            const dropdown = document.getElementById('filterDropdown');
            const target = event.currentTarget.closest('th'); 
            
            if (currentFilterColumn === key) {
                closeModalFilter();
                return;
            }

            currentFilterColumn = key;
            dropdown.innerHTML = '';
            
            const rect = target.getBoundingClientRect();
            const wrapperRect = document.querySelector('.ot-table-wrapper').getBoundingClientRect();
            
            dropdown.style.top = `${rect.bottom - wrapperRect.top}px`;
            dropdown.style.left = `${rect.left - wrapperRect.left}px`;
            dropdown.style.display = 'block';

            const uniqueValues = {};
            fullOTList.forEach(ot => {
                const value = getOTValue(ot, key);
                uniqueValues[value] = true;
            });
            const sortedValues = Object.keys(uniqueValues).sort();

            let htmlContent = `<div class="filter-header">Filtrer par ${target.textContent.replace('Filtrer', '').trim()}</div>`;
            
            htmlContent += `
                <div class="filter-item">
                    <input type="checkbox" id="filter-select-all" checked onchange="toggleSelectAll(this, '${key}')">
                    <label for="filter-select-all">Tout s√©lectionner</label>
                </div>
                <hr style="margin: 5px 0;">
            `;

            sortedValues.forEach(value => {
                const isChecked = !activeFilters[key] || activeFilters[key].includes(value);
                // Utiliser une m√©thode de nettoyage fiable pour l'ID HTML
                const id = `filter-${key}-${value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                htmlContent += `
                    <div class="filter-item">
                        <input type="checkbox" id="${id}" value="${value}" ${isChecked ? 'checked' : ''}>
                        <label for="${id}">${value}</label>
                    </div>
                `;
            });
            
            htmlContent += `
                <div class="filter-actions">
                    <button class="apply-btn" onclick="applyColumnFilter('${key}')">Appliquer</button>
                    <button class="clear-btn" onclick="clearColumnFilter('${key}')">Effacer</button>
                </div>
            `;

            dropdown.innerHTML = htmlContent;
        }
        
        function toggleSelectAll(checkbox, key) {
            const dropdown = document.getElementById('filterDropdown');
            const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#filter-select-all)');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function applyColumnFilter(key) {
            const dropdown = document.getElementById('filterDropdown');
            const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#filter-select-all):checked');
            
            const selectedValues = Array.from(checkboxes).map(cb => cb.value);

            if (selectedValues.length === 0) {
                activeFilters[key] = []; 
            } else if (selectedValues.length === fullOTList.length) {
                delete activeFilters[key]; 
            } else {
                activeFilters[key] = selectedValues;
            }

            closeModalFilter();
            filterTable();
        }
        
        function clearColumnFilter(key) {
            delete activeFilters[key];
            closeModalFilter();
            filterTable();
        }


        // ------------------------------------------------------------------
        // FONCTION PRINCIPALE DE FILTRAGE ET RECHERCHE (AVEC PAGINATION)
        // ------------------------------------------------------------------
        function filterTable(resetPage = true) {
            closeModalFilter();

            const searchInput = document.getElementById('searchInput').value.toUpperCase();
            const tableBody = document.getElementById('otTableBody');
            tableBody.innerHTML = ''; 
            
            if (fullOTList.length === 0) {
                document.getElementById('paginationInfo').textContent = "0 r√©sultats.";
                return;
            }

            // 1. D√©terminer les filtres appliqu√©s
            
            // R√©cup√©rer le statut s√©lectionn√©
            const selectedStatus = document.getElementById('filterStatus').value.toUpperCase();

            const filteredList = fullOTList.filter(ot => {
                
                // --- Exclure les tickets archiv√©s ---
                if (ot.archived === true || ot.archived === 'true') {
                    return false;
                }
                
                // --- A. FILTRE PAR STATUT (R√©activ√©) ---
                if (selectedStatus && selectedStatus !== "") {
                    const currentStatus = String(ot.Statut || ot.statut || '').toUpperCase().trim();
                    if (currentStatus !== selectedStatus) {
                        return false;
                    }
                }
                
                // --- B. Recherche textuelle globale ---
                const id = String(ot.ID || ot.Timestamp || '').toUpperCase();
                const designation = String(ot.designation || ot.D√©signation || '').toUpperCase();
                const siteCode = String(ot.codeSite || ot.CodeSite || ot.siteCode || '').toUpperCase();

                const textMatch = id.includes(searchInput) || 
                                  designation.includes(searchInput) || 
                                  siteCode.includes(searchInput);

                if (!textMatch) return false;

                // --- C. Filtres par Colonne (Excel-like) ---
                for (const key in activeFilters) {
                    if (activeFilters[key].length === 0) {
                        return false; 
                    }
                    
                    const otValue = getOTValue(ot, key);
                    
                    if (activeFilters[key] && !activeFilters[key].includes(otValue)) {
                        return false;
                    }
                }

                return true;
            }).sort((a,b)=>{const dateA=a.dateLimite?new Date(a.dateLimite):new Date('9999-12-31');const dateB=b.dateLimite?new Date(b.dateLimite):new Date('9999-12-31');return dateA.getTime()-dateB.getTime()});
            
            // 2. LOGIQUE DE PAGINATION
            const itemsPerPage = parseInt(document.getElementById('itemsPerPage').value) || 10;
            const totalItems = filteredList.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (resetPage) {
                currentPage = 1;
            }
            
            // S'assurer que la page actuelle est valide
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (currentPage <= 0) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            
            // Liste √† afficher (sous-ensemble)
            const listToDisplay = filteredList.slice(startIndex, endIndex);

            // 3. Affichage de l'information de pagination
            document.getElementById('paginationInfo').textContent = 
                `Affichage des √©l√©ments ${startIndex + 1} √† ${endIndex} sur ${totalItems} (Page ${currentPage} de ${totalPages || 1})`;
            
            // Si la liste filtr√©e est vide
            if (filteredList.length === 0) {
                const colspanCount = 10;
                tableBody.innerHTML = `<tr><td colspan="${colspanCount}" style="text-align:center; font-style: italic;">Aucun r√©sultat trouv√©.</td></tr>`;
                renderPaginationControls(0); // Cache les contr√¥les
                return;
            }

            // 4. Construire le Tableau
            listToDisplay.forEach(ot => {
                
                const row = tableBody.insertRow();
                
                const rawStatus = ot.Statut || '√Ä d√©finir';
                
                // Logique de cr√©ation de la classe sans accent et sans caract√®re sp√©cial
                const statutClass = `status-${rawStatus
                    .normalize("NFD") 
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^a-zA-Z0-9]/g, '_') 
                    .replace(/__+/g, '_')
                }`;
                
                const statutRaw = rawStatus.toUpperCase().trim();
                const statutResolus = ["R√âSOLU", "RESOLU", "TERMIN√â", "TERMINER", "RESOLU.", "ANNUL√â"];

                // Calcul du retard (J+X)
                const dateLimiteVal = ot.dateLimite ? new Date(ot.dateLimite) : null;
                const aujourdHui = new Date();
                aujourdHui.setHours(0, 0, 0, 0); 

                let statutRetard = dateLimiteVal ? dateLimiteVal.toLocaleDateString('fr-FR') : 'N/A';
                
                // Calcul des jours de retard : Math.floor() garantit que le retard ne commence qu'√† J+1
                const oneDay = 1000 * 60 * 60 * 24;
                const daysOverdue = dateLimiteVal 
                    ? Math.floor((aujourdHui.getTime() - dateLimiteVal.getTime()) / oneDay) 
                    : 0;

                if (daysOverdue > 0 && !statutResolus.includes(statutRaw)) {
                    statutRetard = `<span class="retard">J+${daysOverdue}</span>`;
                    row.classList.add('row-retard');
                }
                
                const prioClass = `priority-${ot.priorite || ot.prio || 'P4'}`;
                const majeurClass = `majeur-${ot.majeur || ot.Majeur || 'RESEAU'}`; 
                
                const displayID = ot.ID || ot.Timestamp.substring(0, 10);
                
                // Date Pr√©vue 
                const datePrevue = ot.dateDebPres ? new Date(ot.dateDebPres).toLocaleDateString('fr-FR') : 'N/A';
                
                const assignee = ot['Exec. Sal.'] || ot['Exec Sal'] || '(√Ä assigner)';

                row.onclick = () => openEditModal(ot); 
                row.style.cursor = 'pointer';

                row.innerHTML = `
                    <td>${displayID}</td>
                    <td>${ot.designation || ot.D√©signation || 'N/A'}</td>
                    <td>${(ot.codeSite || ot.CodeSite || ot.siteCode || 'N/A').toUpperCase()}</td>
                    <td><span class="${prioClass}">${ot.priorite || ot.prio || 'N/A'}</span></td>
                    <td><span class="${majeurClass}">${ot.majeur || ot.Majeur || 'N/A'}</span></td>
                    <td><span class="${statutClass}">${rawStatus}</span></td>
                    <td>${datePrevue}</td>
                    <td>${statutRetard}</td>
                    <td>${assignee}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="delete-button" onclick="deleteTicket(${ot.rowIndex})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
            });
            
            // 5. Affichage des contr√¥les de pagination
            renderPaginationControls(totalPages);
        }

        // Fonction pour g√©n√©rer les boutons de pagination
        function renderPaginationControls(totalPages) {
            const controlsContainer = document.getElementById('paginationControls');
            controlsContainer.innerHTML = '';
            
            if (totalPages <= 1) return; 
            
            const buttonStyle = 'padding: 8px 12px; border: 1px solid var(--free-primary); border-radius: 4px; background-color: #fff; color: var(--free-primary); cursor: pointer; margin: 0 5px;';
            const disabledStyle = 'opacity: 0.5; cursor: not-allowed;';

            // Bouton Pr√©c√©dent
            const prevButton = document.createElement('button');
            prevButton.textContent = "¬´ Pr√©c√©dent";
            if (currentPage > 1) {
                prevButton.onclick = () => { currentPage--; filterTable(false); };
                prevButton.style.cssText = buttonStyle;
            } else {
                prevButton.disabled = true;
                prevButton.style.cssText = buttonStyle + disabledStyle;
            }
            controlsContainer.appendChild(prevButton);
            
            // Informations sur la page
            const pageInfo = document.createElement('span');
            pageInfo.textContent = ` Page ${currentPage} de ${totalPages} `;
            pageInfo.style.margin = '0 10px';
            controlsContainer.appendChild(pageInfo);

            // Bouton Suivant
            const nextButton = document.createElement('button');
            nextButton.textContent = "Suivant ¬ª";
            if (currentPage < totalPages) {
                nextButton.onclick = () => { currentPage++; filterTable(false); };
                nextButton.style.cssText = buttonStyle;
            } else {
                nextButton.disabled = true;
                nextButton.style.cssText = buttonStyle + disabledStyle;
            }
            controlsContainer.appendChild(nextButton);
        }
        
        // ------------------------------------------------------------------
        // FONCTION DE CHARGEMENT INITIAL
        // ------------------------------------------------------------------
        function loadOTList() {
            const tableBody = document.getElementById('otTableBody');
            const colspanCount = 10; 
            tableBody.innerHTML = `<tr><td colspan="${colspanCount}" style="text-align:center; padding: 20px;">Chargement des donn√©es...</td></tr>`;
            
            fetch(WEB_APP_URL, { method: "GET" })
            .then(response => response.text())
            .then(text => {
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("Erreur de d√©codage JSON:", text);
                    document.getElementById('kpiTotal').textContent = 'ERR';
                    document.getElementById('kpiEnAttente').textContent = 'ERR';
                    document.getElementById('kpiEnRetard').textContent = 'ERR';
                    document.getElementById('kpiResolus').textContent = 0; 
                    throw new Error("Erreur de format de donn√©es re√ßues.");
                }

                const list = data.list || [];
                const kpis = data.kpis || {};
                
                // Correction KPI: Afficher 0 si le calcul est indisponible.
                const resolvedKpiValue = (
                    kpis.otResolusCeMois === 'N/A (Col. Date R√©s. Manquante)' || 
                    kpis.otResolusCeMois === undefined || 
                    kpis.otResolusCeMois === null
                ) ? 0 : kpis.otResolusCeMois;

                fullOTList = list;
                
                // 1. MISE √Ä JOUR DES CARTES KPI
                document.getElementById('kpiTotal').textContent = kpis.totalOT || 0;
                document.getElementById('kpiEnAttente').textContent = kpis.otEnAttenteCloture || 0;
                document.getElementById('kpiEnRetard').textContent = kpis.otEnRetard || 0;
                document.getElementById('kpiResolus').textContent = resolvedKpiValue;

                // 2. AFFICHER TOUTES LES DONN√âES (d√©clenche la pagination et l'affichage des 10 premiers)
                filterTable(true); 
            })
            .catch(error => {
                console.error('Erreur lors du chargement des OT:', error);
                tableBody.innerHTML = `<tr><td colspan="${colspanCount}" style="text-align:center; color: red;">Erreur de connexion aux donn√©es.</td></tr>`;
                document.getElementById('kpiResolus').textContent = 0; 
            });
        }


        // ------------------------------------------------------------------
        // FONCTION D'√âCRITURE (AJOUT, SUPPRESSION, UPDATE)
        // ------------------------------------------------------------------
        
        function deleteTicket(rowIndex) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ce ticket (ligne Sheet: ${rowIndex}) ?`)) {
                return; 
            }

            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('rowIndex', rowIndex);

            fetch(WEB_APP_URL, { method: "POST", body: formData, mode: 'no-cors' })
            .then(() => {
                alert("‚úÖ Ticket supprim√© avec succ√®s !");
                // Recharger en gardant le m√™me filtre/page
                loadOTList();
            })
            .catch(error => {
                console.error('Erreur lors de la suppression du ticket:', error);
                alert("‚ùå Erreur lors de la suppression du ticket.");
            });
        }

        function archiveTicket(rowIndex) {
            const ticket = fullOTList.find(ot => ot.rowIndex === rowIndex);
            if (!ticket) {
                alert('Ticket non trouv√©');
                return;
            }
            
            if (!confirm(`√ätes-vous s√ªr de vouloir archiver ce ticket (${ticket.ID}) ? Il ne sera plus affich√© dans la liste.`)) {
                return; 
            }

            const formData = new FormData();
            formData.append('action', 'archive');
            formData.append('rowIndex', rowIndex);
            formData.append('archived', 'true');

            fetch(WEB_APP_URL, { method: "POST", body: formData, mode: 'no-cors' })
            .then(() => {
                alert("‚úÖ Ticket archiv√© avec succ√®s !");
                // Marquer localement comme archiv√©
                ticket.archived = true;
                loadOTList();
            })
            .catch(error => {
                console.error('Erreur lors de l\'archivage du ticket:', error);
                // Marquer localement quand m√™me
                ticket.archived = true;
                loadOTList();
            });
        }

        function archiveTicketFromModal() {
            const rowIndex = document.getElementById('editRowIndex').value;
            closeEditModal();
            archiveTicket(rowIndex);
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const data = new FormData(form);
            const siteCode = form.querySelector('#siteCode').value.trim().toUpperCase();
            data.set('codeSite', siteCode);
            data.append('action', 'add'); 

            const submitButton = form.querySelector('.form-submit-button');
            submitButton.textContent = "Envoi en cours...";
            submitButton.disabled = true;

            fetch(WEB_APP_URL, { method: "POST", body: data, mode: 'no-cors' })
            .then(() => {
                alert("‚úÖ Ticket OT cr√©√© avec succ√®s et enregistr√© dans Google Sheets !");
                closeModal();
                form.reset();
                loadOTList(); 
            })
            .catch(error => {
                console.error('Erreur de connexion:', error);
                alert("‚ùå Erreur de connexion ou donn√©es non envoy√©es.");
            })
            .finally(() => {
                submitButton.textContent = "Soumettre le Ticket";
                submitButton.disabled = false;
            });
        }
        
        function handleEditSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const data = new FormData(form);
            
            data.append('action', 'update');
            
            const submitButton = form.querySelector('.form-submit-button');
            submitButton.textContent = "Mise √† jour...";
            submitButton.disabled = true;

            fetch(WEB_APP_URL, { method: "POST", body: data, mode: 'no-cors' })
            .then((response) => {
                alert("‚úÖ Ticket mis √† jour avec succ√®s !");
                closeEditModal();
                loadOTList(); 
            })
            .catch(error => {
                console.error('Erreur lors de la mise √† jour du ticket:', error);
                alert("‚ùå Erreur lors de la mise √† jour du ticket.");
            })
            .finally(() => {
                submitButton.textContent = "Enregistrer les Modifications";
                submitButton.disabled = false;
            });
        }

        // ===== SYST√àME DE COMMENTAIRES HISTORIS√âS =====
        function nowIso() {
            return new Date().toISOString();
        }

        function renderMergedHistoryOT(ot, ticketId) {
            const historyLog = document.getElementById('historyLog');
            historyLog.innerHTML = '';
            
            // R√©cup√©rer les modifications
            const history = (ot.Historique || []).map(entry => ({
                type: 'modification',
                timestamp: entry.timestamp,
                user: entry.user,
                change: entry.change
            }));
            
            // R√©cup√©rer les commentaires
            let comments = [];
            try {
                const stored = localStorage.getItem(`ot_comments_${ticketId}`);
                comments = stored ? JSON.parse(stored) : [];
            } catch {}
            
            const commentsData = comments.map(entry => ({
                type: 'commentaire',
                ts: entry.ts,
                author: entry.author,
                text: entry.text
            }));
            
            // Fusionner et trier chronologiquement (plus r√©cent en premier)
            const merged = [...history, ...commentsData].sort((a, b) => {
                const timeA = new Date(a.timestamp || a.ts);
                const timeB = new Date(b.timestamp || b.ts);
                return timeB - timeA;
            });
            
            if (merged.length === 0) {
                historyLog.innerHTML = '<div style="text-align:center; color:#888; font-style:italic;">Aucune modification ou commentaire enregistr√© pour ce ticket.</div>';
                return;
            }
            
            const timelineDiv = document.createElement('div');
            timelineDiv.className = 'history-timeline';
            
            merged.forEach(entry => {
                const dateHeure = formatHistoryDate(entry.timestamp || entry.ts);
                
                const entryDiv = document.createElement('div');
                entryDiv.className = 'history-entry';
                
                if (entry.type === 'modification') {
                    let changeText = entry.change;
                    changeText = changeText.replace(/:\s*\"([^\"]*)\"/g, ': <strong>"$1"</strong>');
                    entryDiv.innerHTML = `
                        <div class="history-meta">
                            <span>üîÑ Modification par: <strong>${entry.user.split('@')[0]}</strong></span>
                            <span>${dateHeure}</span>
                        </div>
                        <div class="history-change">${changeText}</div>
                    `;
                } else {
                    entryDiv.innerHTML = `
                        <div class="history-meta">
                            <span>üí¨ Commentaire par: <strong>${entry.author || 'Anonyme'}</strong></span>
                            <span>${dateHeure}</span>
                        </div>
                        <div class="history-change" style="padding:8px;background:#fff;border-radius:6px;border:1px solid #eee;white-space:pre-wrap;word-wrap:break-word;">${escapeHtml(entry.text)}</div>
                    `;
                }
                
                timelineDiv.appendChild(entryDiv);
            });
            
            historyLog.appendChild(timelineDiv);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addCommentOT() {
            const ticketIdElement = document.getElementById('editTicketID');
            const ticketId = ticketIdElement ? ticketIdElement.textContent.trim() : '';
            const text = document.getElementById('newCommentText')?.value?.trim();
            const author = document.getElementById('newCommentAuthor')?.value?.trim();
            
            if (!ticketId || !text) {
                alert('Veuillez remplir le commentaire et s√©lectionner un ticket.');
                return;
            }
            
            let comments = [];
            try {
                const stored = localStorage.getItem(`ot_comments_${ticketId}`);
                comments = stored ? JSON.parse(stored) : [];
            } catch {}
            
            const entry = { ts: nowIso(), author: author || '', text };
            comments.push(entry);
            
            localStorage.setItem(`ot_comments_${ticketId}`, JSON.stringify(comments));
            
            // Clear inputs
            document.getElementById('newCommentText').value = '';
            document.getElementById('newCommentAuthor').value = '';
            
            // Re-render merged history
            const currentOT = {
                ID: ticketId,
                Historique: []
            };
            renderMergedHistoryOT(currentOT, ticketId);
        }
    </script>
</body>
</html>